#lang #lang-c_sharp #aspnet

---
**Источники конфигураций:**
- Файлы (json, xml)
- Аргументы командной строки
- Переменные среды окружения
- Объекты .NET
- Незашифрованное хранилище Secret Manager
- Также можно создать свой провайдер конфигурации логгера.

### Принцип работы фабрики с конфигурацией

При создании логгера объект `ILoggerFactory` выбирает и применяет одно правило для каждого провайдера. 
Выбор нужного правила состоит из ряда этапов:
<br>
1. Выбираются все правила, которые соответствуют провайдеру. Если таких правил нет, то выбираются все правила, общие для всех провайдеров.
<br>
2. Выбирается правило, которое имеет наиболее длинное соответствие имени категории. Если такого нет, то выбираются все правила, общие для всех категорий.
<br>
3. Выбирается самое последнее (Порядковый номер правила соответствует его порядку определения. Причем правила из файла конфигурации предшествуют правилам, определенным в коде).
<br>
4. Если на предыдущем шаге не выбрано никаких правил, то применяется настройка `MinimumLevel`. 

### JSON Конфигурация
Файл - `appsettings.json`

- Настройки узла `Logging.{имя_провайдера}.LogLevel` переопределяют настройки в узле `Logging.LogLevel`
- Можно определять фильтры сразу и в коде C#, и в файле конфигурации.

```json
{
  "Logging": { // конфиг логгера
    "Debug": { // режим запуска Debug
      "LogLevel": { // минимальный уровень логирования
        "Default": "Debug" // для всех категорий
      }
    },
    "Console": {
      "LogLevel": {
        "Default": "Information",
        "Microsoft.AspNetCore": "Warning" // для категории Microsoft.AspNetCore
      }
    },
    "LogLevel": {
      "Default": "Error"
    }
  },
  "AllowedHosts": "*"
}
```


### Глобальная настройка логгирования через фабрику

- Также за глобальную установку настроек логгирования отвечает свойство `Logging` класса `WebApplicationBuilder`.
- Глобальная настройка логгирования должна идти до создания объекта `WebApplication`.

```csharp
using Microsoft.Extensions.Logging.Debug;
//....................
 
var loggerFactory = LoggerFactory.Create(builder =>
{
    builder.AddDebug();
    builder.AddConsole();
    // настройка фильтров
    builder.AddFilter("System", LogLevel.Information)
            .AddFilter<DebugLoggerProvider>("Microsoft", LogLevel.Trace);
});
ILogger logger = loggerFactory.CreateLogger("WebApplication");
```

Для глобальной установки настроек логгирования у объекта `WebApplicationBuilder.Logging`. 
**Методы:**
- `AddConfiguration()`: добавляет конфигурацию логгера в виде объекта `IConfiguration`
- `AddConsole()`: добавляет консольный логгер
- `AddConsoleFormatter()`: добавляет объект форматирования для консольного вывода
- `AddJsonConsole()`: добавляет форматирование сообщений консольного логгера в формат "json"
- `AddSimpleConsole()`: добавляет простое форматирование для логгирования на консоль
- `AddDebug()`: добавляет логгер отладки
- `AddEventLog()`: добавляет логгер для вывод в журнал *Windows Event Log*
- `AddEventSourceLogger()`: добавляет логгер для вывода в лог *Event Tracing for Windows*
- `AddFilter()`: добавляет фильтрацию для сообщений логгера
- `AddProvider()`: добавляет провайдер логгирования
- `ClearProviders()`: удаляет все зарегистрированные провайдеры логгирования
- `SetMinimumLevel()`: устанавливает минимальный уровень логгирования


### Outer links:
https://metanit.com/sharp/aspnet6/7.3.php