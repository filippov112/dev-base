#lang #lang-c_sharp #efcore 

---
В EF Core можно сопоставлять `DbSet` не только с таблицами, но и с **представлениями (views)**.
Классы, связанные с представлениями, имеют ограничения:
  - Не требуют определения первичного ключа.
  - Изменения в них **не отслеживаются** контекстом данных.
  - Можно только **читать** данные (нельзя добавлять, изменять, удалять).
  - Нельзя использовать навигационные свойства на такие типы.

---
### Практика
Представление можно создать как через код (`ExecuteSqlRaw`), так и вручную в БД.

- Описание класса представления ничем не выделяется.
- Инициализация в контексте БД:
	```csharp
	public class ApplicationContext : DbContext
	{
		// ...
	    public DbSet<CompanyProductsGroup> ProductsByCompany { get; set; } = null!;
	
	    protected override void OnModelCreating(ModelBuilder modelBuilder)
	    {
	        modelBuilder.Entity<CompanyProductsGroup>(pc =>
	        {
	            pc.HasNoKey();                  // Указываем, что нет первичного ключа
	            pc.ToView("View_ProductsByCompany"); // Связываем с представлением
	        });
	        // ...
	    }
	
		// ...
	}
	```
- Создание представления:
	```csharp
	using (ApplicationContext db = new())
	{
	    // Создание представления
	    db.Database.ExecuteSqlRaw(@"
	        CREATE VIEW View_ProductsByCompany AS 
	        SELECT c.Name AS CompanyName, 
	               Count(p.Id) AS ProductCount, 
	               Sum(p.Price * p.TotalCount) AS TotalSum
	        FROM Companies c
	        INNER JOIN Products p ON p.CompanyId = c.Id
	        GROUP BY c.Name");
	
	    db.SaveChanges();
	}
	```
- Чтение данных такое же как у табличных сущностей.

---
### Outer links:
https://metanit.com/sharp/efcore/8.2.php