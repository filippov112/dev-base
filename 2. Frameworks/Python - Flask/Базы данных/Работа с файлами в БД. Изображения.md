#lang #lang-python #flask 

---
### Создание таблицы `users`

```sql
CREATE TABLE IF NOT EXISTS users (
    id integer PRIMARY KEY AUTOINCREMENT,
    name text NOT NULL,
    email text NOT NULL,
    psw text NOT NULL,
    avatar BLOB DEFAULT NULL,  -- тип данных BLOB
    time integer NOT NULL
);
```

---

## Отображение изображений из БД на странице

```html
<div class="profile-ava">
    <img src="{{ url_for('userava') }}">
</div>
```

- `url_for('userava')` — ссылка на обработчик вывода из БД.
- Форма для загрузки изображения:

```html
<form action="{{url_for('upload')}}" method="POST" enctype="multipart/form-data">
```

- `url_for('upload')` — ссылка на обработчик загрузки в БД.

---

## Обработчик вывода

```python
@app.route('/userava')
@login_required
def userava():
    img = current_user.getAvatar(app)  # Пробуем взять аватар из сессии
    if not img:
        return ""  # Если аватара нет, возвращаем пустую строку
    
    h = make_response(img)  # Создаём пакет
    h.headers['Content-Type'] = 'image/png'  # Указываем тип данных (PNG)
    return h
```

---

## Обработчик загрузки

```python
@app.route('/upload', methods=["POST", "GET"])
@login_required
def upload():
    if request.method == 'POST':  # Исключаем прямой переход по адресу
        file = request.files['file']  # Получаем файл из запроса
        if file and current_user.verifyExt(file.filename):  # Проверка формата файла
            try:
                img = file.read()  # Чтение данных из файла
                res = dbase.updateUserAvatar(img, current_user.get_id())  # Обновление аватара в БД
                if not res:
                    flash("Ошибка обновления аватара", "error")
                    return redirect(url_for('profile'))
                flash("Аватар обновлен", "success")
            except FileNotFoundError as e:
                flash("Ошибка чтения файла", "error")
        else:
            flash("Ошибка обновления аватара", "error")
    return redirect(url_for('profile'))
```

---

## Метод для получения аватара или загрузки аватара по умолчанию

```python
def getAvatar(self, app):
    img = None
    if not self.__user['avatar']:
        try:
            with app.open_resource(app.root_path + url_for('static', filename='images/default.png'), "rb") as f:
                img = f.read()
        except FileNotFoundError as e:
            print("Не найден аватар по умолчанию: " + str(e))
    else:
        img = self.__user['avatar']
    return img
```

---

## Метод проверки формата загружаемого изображения

```python
def verifyExt(self, filename):
    ext = filename.rsplit('.', 1)[1]  # Разделяем имя файла и получаем расширение
    if ext.lower() == "png":  # Проверяем, что расширение PNG
        return True
    return False
```

---

## Метод добавления изображения в базу данных

```python
def updateUserAvatar(self, avatar, user_id):
    if not avatar:
        return False
    try:
        binary = sqlite3.Binary(avatar)  # Преобразуем изображение в бинарный формат
        self.__cur.execute("UPDATE users SET avatar = ? WHERE id = ?", (binary, user_id))
        self.__db.commit()
    except sqlite3.Error as e:
        print("Ошибка обновления аватара в БД: " + str(e))
        return False
    return True
```
