#lang #lang-js

# 12. Замыкания и вложенные функции

### **Lexical Environment**

В действительности, при запуске любого скрипта создается **глобальное лексическое окружение (Lexical Environment)**. Оно состоит из двух частей:

1. **Environment Record** – объект, в котором хранятся локальные данные как свойства этого объекта.
2. Ссылка на внешнее лексическое окружение (если его нет, то эта ссылка равна null).

![](heap/_files/js/Pasted%20image%2020241001211028.png)

### **Основные правила**

1. Внешнее лексическое окружение не имеет доступа к данным внутренних окружений.
2. Поиск переменных начинается с текущего окружения и при необходимости последовательно переходит к внешним окружениям. Останавливается, как только переменная найдена.
3. Лексическое окружение автоматически уничтожается, когда в нем более нет необходимости (на него нет внешних ссылок).
4. Свои лексические окружения создают не только вызываемые функции, но и условные операторы.

- И в современных браузерах даже просто проставленные фигурные скобки:

  ```javascript
  {
      // внутреннее лексическое окружение     
  }
  ```

# **Замыкания**

```javascript
function createCounter() {
    let count = 0;

    return function() {
        return count++;
    };
}

let counter = createCounter();

console.log(counter());
```

- Вначале в глобальном окружении появляется такое свойство **createCounter**.
- Далее, эта функция вызывается. Создается ее локальное лексическое окружение с переменной **count** и **анонимной функцией**. На эту анонимную функцию **ссылается переменная counter** из глобального окружения. В результате, после завершения выполнения функции `createCounter()` ее локальное окружение **не уничтожается**.

![](heap/_files/js/Pasted%20image%2020241001211046.png)

- Далее, в программе идет вызов **анонимной функции**. Появляется **еще одно лексическое пространство** этой функции и картина выглядит уже вот так:

![](heap/_files/js/Pasted%20image%2020241001211054.png)

Анонимная функция берет переменную `count` из внешнего лексического пространства, возвращает ее и увеличивает на 1. Вот такое обращение в теле функции **к переменной из внешнего лексического окружения** в программировании называют **замыканием**.
- При завершении, лексическое пространство анонимной функции уничтожается и остается два пространства:

![](heap/_files/js/Pasted%20image%2020241001211103.png)

Но значение `count` теперь равно 1. Если мы вызовем `counter()` еще раз, то получим значение 1 и переменная `count` станет равной 2. И так далее.
