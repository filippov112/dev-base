#lang #lang-python 

# Способы сохранения данных в БД

При работе с базами данных на языке Python с использованием библиотеки SQLite важно правильно управлять соединениями и транзакциями. Рассмотрим основные способы сохранения данных.

## Использование контекстного менеджера

```python
with sq.connect("cars.db") as con:
    cur = con.cursor()
```

Когда контекстный менеджер завершает свою работу, он автоматически выполняет два метода:
- `con.commit()` – применение всех изменений в таблицах БД.
- `con.close()` – закрытие соединения с БД.

Это необходимые действия для сохранения внесенных изменений в БД.

## Вставка данных в таблицы

```python
for car in cars:
    cur.execute("INSERT INTO cars VALUES(NULL, ?, ?)", car)
```
Здесь вместо знаков вопроса будут подставлены соответствующие данные из первого кортежа списка.

```python
cur.executemany("INSERT INTO cars VALUES(NULL, ?, ?)", cars)
```
Это тот же цикл по сути.

## Обновление и удаление данных

```python
cur.execute("UPDATE cars SET price = :Price WHERE model LIKE 'A%'", {'Price': 0})
```
Этот запрос работает по метке, обозначенной двоеточием (плейсхолдеры).

```python
cur.executescript("""
    DELETE FROM cars WHERE model LIKE 'A%';
    UPDATE cars SET price = price + 1000;
""")
```
Этот метод последовательно выполняет несколько запросов. Однако `executescript` не поддерживает динамические запросы, как в предыдущих примерах.

## Создание таблицы и обработка ошибок

```python
try:
    cur.executescript("""
        CREATE TABLE IF NOT EXISTS cars (
            car_id INTEGER PRIMARY KEY AUTOINCREMENT,
            model TEXT,
            price INTEGER
        );
        BEGIN;  -- метка точки сохранения
        INSERT INTO cars VALUES(NULL, 'Audi', 52642);
        INSERT INTO cars VALUES(NULL, 'Mercedes', 57127);
        INSERT INTO cars VALUES(NULL, 'Skoda', 9000);
        INSERT INTO cars VALUES(NULL, 'Volvo', 29000);
        INSERT INTO cars VALUES(NULL, 'Bentley', 350000);
        UPDATE cars SET price = price + 1000;
    """)
    con.commit()  -- сохраняет изменения в исходной БД
except sq.Error as e:
    if con:
        con.rollback()  -- откатывает БД к состоянию до метки сохранения
    print("Ошибка выполнения запроса")
finally:
    if con:
        con.close()  -- закрывает соединение с БД
```

## Настройка уровня изоляции

Если при работе с БД предполагается сохранять вносимые изменения сразу после выполнения SQL-запроса, то это можно сделать с помощью метода `connect`, установив в нем параметр `isolation_level=None`:

```python
con = sq.connect("cars.db", isolation_level=None)
```
Обратите внимание, что это также замедляет работу с БД из-за постоянного сохранения всех изменений.

## Получение последнего добавленного идентификатора

```python
cur.lastrowid  -- возвращает row_id последней добавленной курсором записи.
```
