#lang #lang-python 

---
#### Идентификация узких мест

- **cProfile:** стандартный модуль для измерения времени выполнения функций.
```python
# some-code.py
from decimal import *
def exp(x):    
	getcontext().prec += 2    
	i, lasts, s, fact, num = 0, 0, 1, 1, 1    
	while s != lasts:        
		lasts = s        
		i += 1        
		fact *= i        
		num *= x        
		s += num / fact    
	getcontext().prec -= 2    
	return +sexp(Decimal(3000))
```
```bash
python -m cProfile -s cumulative some-code.py         
		1052 function calls (1023 primitive calls) in 2.765 seconds   
	Ordered by: cumulative timek   
	ncalls  tottime  percall  cumtime  percall filename:lineno(function)      
	5/1    0.000    0.000    2.765    2.765 {built-in method builtins.exec}        
	1    0.000    0.000    2.765    2.765 some-code.py:1(<module>)        
	1    2.764    2.764    2.764    2.764 some-code.py:3(exp)      
	4/1    0.000    0.000    0.001    0.001 <frozen importlib._bootstrap>:986(_find_and_load)      
	4/1    0.000    0.000    0.001    0.001 <frozen importlib._bootstrap>:956(_find_and_load_unlocked)      
	4/1    0.000    0.000    0.001    0.001 <frozen importlib._bootstrap>:650(_load_unlocked)      
	3/1    0.000    0.000    0.001    0.001 <frozen importlib._bootstrap_external>:842(exec_module)      
	5/1    0.000    0.000    0.001    0.001 <frozen importlib._bootstrap>:211(_call_with_frames_removed)        
	1    0.000    0.000    0.001    0.001 decimal.py:2(<module>)...

```
- **py-spy:** профилировщик для анализа работающих программ (в том числе удаленных).
```bash
pip install py-spypython some-code.py &[1] 1129587
ps -A -o pid,cmd | grep python
...
1129587 python some-code.py
1130365 grep python
sudo env "PATH=$PATH" py-spy top --pid 1129587
```
![](heap/_files/Pasted%20image%2020240613213852.png)
- **line_profiler:** профилировщик для определения времени выполнения каждой строки кода.
![](heap/_files/Pasted%20image%2020240613214146.png)
- **pyheat:** инструмент, генерирующий тепловую карту для строк/областей кода, выполняющихся дольше всего.
![](heap/_files/Pasted%20image%2020240613214202.png)
- **memory_profiler:** инструмент для анализа использования памяти.
![](heap/_files/Pasted%20image%2020240613214213.png)
##### Более глубокое исследование кода
- **Дизассемблирование:** позволяет изучить байт-код, используемый интерпретатором Python.
![](heap/_files/Pasted%20image%2020240613214341.png)
- **Изучение работы Python:** понимание внутренних операций Python может помочь в оптимизации.


#### Подходы к решению проблем
- **PyPy:** JIT-компилятор, может дать прирост производительности без изменений кода.
- **Cython:** компилятор, использующий C-подобные аннотации типов для создания модулей расширения Python.
- **Prometeo:** встраиваемый язык, отражающий специфику предметной области, основанный на Python.
- **C/Fortran:** написание оптимизированного кода на C/Fortran и вызов его из Python.

#### Итоги
- Не оптимизируйте без причины, используйте профилировщики.
- Создавайте воспроизводимые тесты производительности.