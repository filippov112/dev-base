#Django #Python 

# 5. CRUD - основы ORM по работе с моделями

CRUD - (Create – создание; Read – чтение; Update – изменение; Delete – удаление)
Почти все проекты, построенные на Django, используют его встроенную ORM, не переходя на уровень SQL-запросов. Каждый экземпляр класса-модели представляет собой одну отдельную запись таблицы.

## Для демонстрации работы с ORM

В терминале выполним команду, чтобы войти в консоль фреймворка:

```sh
python manage.py shell
```

Выполним импорт модели:

```python
from women.models import Women
```

### Инициализация записи

```python
Women(title='Анджелина Джоли', content='Биография Анджелины Джоли')
```

### Создание записи

```python
w1 = _  # возвращает последнюю команду (w1 = Women(title...))
```

### Сохранение записи в таблицу (отправка запроса)

```python
w1.save()
```

> При добавлении записи в таблицу, ссылка на запись не теряется. К ней по-прежнему можно обращаться через переменную (w1). Django будет взаимодействовать через SQL-запросы с записью по сохраненному в экземпляре pk-ключу.

```python
w1.pk  # атрибут первичного ключа (в SQLite rowid)
```

## Менеджер записей `objects`

```python
Women.objects.create(title='Кира Найтли', content='Биография Киры Найтли')
```

- добавляет записи в таблицу

```python
Women.objects.all()  # возвращает список из записей (экземпляров)
```

Можно перегрузить метод отображения экземпляров:

```python
def __str__(self):
    return self.title
```

```python
Women.objects.filter(title='Энн Хэтэуэй')  # список с фильтром
Women.objects.exclude(pk=2)  # обратный фильтр (исключающий записи с аттрибутом pk=2)
```

Фильтр работает только с именованными параметрами (только знак =). Для сравнения используются добавления к именам атрибутов:

- `<имя атрибута>__gte` – сравнение больше или равно (>=);
- `<имя атрибута>__lte` – сравнение меньше или равно (<=).

```python
Women.objects.get(pk=2)  # возвращает одну запись по фильтру (либо исключение, если <>1)
```

## Сортировка записей

```python
Women.objects.filter(pk__lte=4).order_by('title')
Women.objects.order_by('title')  # .all().order_by('title')
Women.objects.order_by('-title')  # реверс сортировки
```

## Изменение записей

Считываем ссылку - составляем запрос на изменение - отправляем запрос СУБД:

```python
wu = Women.objects.get(pk=2)
wu.title = 'Марго Робби'
wu.content = 'Биография Марго Робби'
wu.save()
```

## Множественное изменение

Получаем ссылки через запрос к БД. Отправляем запрос БД на изменение записей по полученным ссылкам:

```python
wu.update(cat_id=1)
```

## Удаление записей

Считываем ссылку - отправляем запрос на удаление записи по ссылке:

```python
wd = Women.objects.filter(pk__gte=4)
wd.delete()
```

Подробнее на сайте [djbook.ru](https://djbook.ru/rel3.0/topics/db/queries.html)
