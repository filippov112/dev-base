#Python #Django

# 20. Оптимизация с Django Debug Toolbar

## Критерии оптимизации:
- **Скорость работы приложения**
- **Нагрузка на СУБД** (частота и сложность запросов)
- **Корректность возвращаемых пользователю данных**

Чтобы отслеживать эти и некоторые другие характеристики разрабатываемой программы, в Django имеется довольно удобный инструмент — **Django Debug Toolbar**.

---

## Установка и настройка Django Debug Toolbar

1. **Установка через терминал:**
   ```bash
   pip install django-debug-toolbar
   ```

2. **Регистрация приложения в `settings.py`:**
   ```python
   INSTALLED_APPS = [
       ...,
       'debug_toolbar',
   ]
   MIDDLEWARE = [
       ...,
       'debug_toolbar.middleware.DebugToolbarMiddleware',
   ]
   INTERNAL_IPS = ['127.0.0.1']  # список отслеживаемых IP-адресов
   ```

3. **Добавление маршрутов в `urls.py` в режиме DEBUG:**
   ```python
   if settings.DEBUG:
       import debug_toolbar
       urlpatterns = [
           path('__debug__/', include(debug_toolbar.urls)),
       ] + urlpatterns
       urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
   ```

Всё готово!

---

## Особенности работы с запросами

- Тулбар позволяет, например, отслеживать SQL-запросы и дубликаты при загрузке страниц. 

### Понятия "ленивых" и "жадных" запросов в Django:

- **Ленивые (отложенные) запросы** — выполняются только в момент непосредственного обращения к данным. Например, для вывода рубрики:
  ```html
  <p class="first">Категория: {{ p.cat }}</p>
  ```
  Здесь `p` — объект таблицы `women`, а `cat` — ссылка на таблицу `category`. Вместо одного запроса на получение данных по всем объектам `women`, выполняется каждый раз новый запрос к таблице `category` от каждой записи `women`.

- **Жадные запросы** — выполняют загрузку данных, связанных по внешнему ключу типа `ForeignKey` (запрос сразу по 2 таблицам):
  - `select_related(key)` — если `key` имеет тип `ForeignKey`
  - `prefetch_related(key)` — если `key` имеет тип `ManyToManyField`

### Пример жадного запроса:
```python
def get_queryset(self):
    return Women.objects.filter(is_published=True).select_related('cat')
```
