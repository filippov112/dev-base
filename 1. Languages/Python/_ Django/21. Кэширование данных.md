#lang #lang-python #django

---
[Документация по кэшированию](https://djbook.ru/rel3.0/topics/cache.html)

Кэш в Django можно реализовать следующими способами:
- **На уровне памяти** — это самый быстрый тип кэша.
- **На уровне БД** — наименее распространенный способ.
- **На уровне файловой системы** — наиболее частый вид кэша. (Его мы и рассмотрим)

---

1. В файле `settings.py` необходимо прописать специальный словарь `CACHES`, который отличается в зависимости от ОС сервера.

   ```python
   CACHES = {
       'default': {
           'BACKEND': 'django.core.cache.backends.filebased.FileBasedCache',
           'LOCATION': os.path.join(BASE_DIR, 'coolsite_cache'),
       }
   }
   ```

   В рабочем каталоге нашего проекта будет использоваться папка `coolsite_cache` для хранения кэша. Соответственно, мы ее должны добавить в проекте.

---

Уровни кэширования можно посмотреть на сайте. Также можно настраивать кэш для страниц сайтов целиком и отдельно для шаблонов, устанавливать время хранения кэша и так далее.

---

## КЭШИРОВАНИЕ НА УРОВНЕ ПРЕДСТАВЛЕНИЙ

- Для функций представления предусмотрен декоратор:

  ```python
  @cache_page(60 * 15)  # устанавливающий время кэширования в секундах
  ```

- Для классов представлений в `urls.py`:

  ```python
  from django.views.decorators.cache import cache_page
  
  path('', cache_page(60)(WomenHome.as_view()), name='home')
  ```

  Класс представления заключается параметром к функции кэширования и указывается время (сек).

---

## КЭШИРОВАНИЕ НА УРОВНЕ ШАБЛОНОВ

- Подключение тега кэширования в любом месте шаблона:

  ```django
  {% load cache %}
  ```

- Использование тега кэширования:

  ```django
  {% cache 60 sidebar %}
  ```

  Фрагмент кода с запросами к БД помещается в такой блок, что помогает кэшировать отложенные запросы:

  ```django
  ...
  {% endcache %}
  ```

---

## API НИЗКОГО УРОВНЯ ДЛЯ КЭШИРОВАНИЯ

```python
from django.core.cache import cache

cache.set()  # сохранение произвольных данных в кэш по ключу
cache.get()  # выбор произвольных данных из кэша по ключу
cache.add()  # заносит новое значение в кэш, если его там еще нет (иначе операция игнорируется)
cache.get_or_set()  # извлекает данные из кэша, если их нет, то автоматически заносится значение по умолчанию
cache.delete()  # удаление данных из кэша по ключу
cache.clear()  # полная очистка кэша
```

### Пример

```python
cats = cache.get('cats')  # проверяем наличие данных в кэше по ключу
if not cats:
    cats = Category.objects.annotate(Count('women'))  # если их нет в кэше, делаем запрос как обычно
    cache.set('cats', cats, 60)  # сохраняем на 60 сек полученные данные в кэш
```
