#lang #lang-python 

# 19.1. Авторизация

Документация на русском: [djbook.ru](https://djbook.ru/rel3.0/topics/auth/default.html)

---

## 1. Создадим класс представления страницы авторизации

```python
class LoginUser(DataMixin, LoginView):  # тип представления LoginView(форма авторизации)
    form_class = LoginUserForm  # подключаем свою форму
    template_name = 'women/login.html'

    def get_context_data(self, *, object_list=None, **kwargs):
        context = super().get_context_data(**kwargs)
        c_def = self.get_user_context(title="Авторизация")
        return dict(list(context.items()) + list(c_def.items()))

    def get_success_url(self):  # пропишем адрес перенаправления после авторизации
        return reverse_lazy('home')  # по умолчанию форма перенаправляет на /accounts/profile/
```

---

## 2. Регистрируем адрес представления

```python
path('login/', LoginUser.as_view(), name='login')
```

---

## 3. Создаём шаблон

```html
<div class="form-error">{{ form.non_field_errors }}</div>  <!-- выводим общие ошибки -->

{% for f in form %}
<p><label class="form-label" for="{{ f.id_for_label }}">{{f.label}}: </label>{{ f }}</p>
<div class="form-error">{{ f.errors }}</div>
{% endfor %}
```

---

## 4. Опишем свою форму авторизации на основе базовой `AuthenticationForm`

```python
class LoginUserForm(AuthenticationForm):
    username = forms.CharField(label='Логин', widget=forms.TextInput(attrs={'class': 'form-input'}))
    password = forms.CharField(label='Пароль', widget=forms.PasswordInput(attrs={'class': 'form-input'}))
```

---

## 5. Добавим в базовый шаблон кнопки профиля и деавторизации для авторизованных пользователей

```html
{% if request.user.is_authenticated %}
<li class="last"> <a href="{% url 'profile' %}">Профиль</a> | <a href="{% url 'logout' %}">Выйти</a></li>
{% else %}
<li class="last"><a href="{% url 'register' %}">Регистрация</a> | <a href="{% url 'login' %}">Войти</a></li>
{% endif %}
```

---

## 5.1-2. Добавляем дополнительные представления для деавторизации и профиля

```python
path('logout/', logout_user, name='logout')
path('profile/', Profile.as_view(), name='profile')

def logout_user(request):
    logout(request)  # стандартная функция django для выхода из аккаунта
    return redirect('login')
```

---

## 6. Добавим метод авто-авторизации при регистрации нового пользователя в соответствующий класс представления

```python
def form_valid(self, form):  # вызывается при успешной проверке валидности данных формы
    user = form.save()  # вручную сохраняем пользователя в базе
    login(self.request, user)  # вызываем стандартную функцию авторизации
    return redirect('home')  # перенаправляем на главную страницу
```
