#Csharp #ASP 
# <font color="#00b0f0">ASP.NET:</font> –ö–æ–º–ø—Ä–µ—Å—Å–∏—è (–°–∂–∞—Ç–∏–µ –æ—Ç–≤–µ—Ç–∞)

–°–∂–∞—Ç–∏–µ HTTP-–æ—Ç–≤–µ—Ç–æ–≤ —É–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —É—Å–∫–æ—Ä—è–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü.

üìå **–í–∫–ª—é—á–µ–Ω–∏–µ:**
1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ (–µ—Å–ª–∏ –Ω–µ –≤—Å—Ç—Ä–æ–µ–Ω):
	```sh
	dotnet add package Microsoft.AspNetCore.ResponseCompression
	```
2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º `ResponseCompressionOptions`.
	```csharp
	builder.Services.AddResponseCompression(options =>
	{
	    options.EnableForHttps = true;
	});
	```
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ middleware:
	```csharp
	app.UseResponseCompression();
	```

üì° **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Å–∂–∞—Ç–∏—è:**
–ë—Ä–∞—É–∑–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–º–∏ –∏–º —Ñ–æ—Ä–º–∞—Ç–∞–º–∏: `Accept-Encoding: gzip, br, deflate`.
–°–µ—Ä–≤–µ—Ä –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –∏–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ: `Content-Encoding`.

üì¶ **–ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏**, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ ASP.NET Core:

|–§–æ—Ä–º–∞—Ç|–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏|
|---|---|
|**Brotli**|–õ—É—á—à–µ–µ —Å–∂–∞—Ç–∏–µ, —á—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ–º –±—Ä–∞—É–∑–µ—Ä–æ–≤.|
|**Gzip**|–ß—É—Ç—å —Ö—É–∂–µ —Å—Ç–µ–ø–µ–Ω—å —Å–∂–∞—Ç–∏—è, –Ω–æ –±—ã—Å—Ç—Ä–µ–µ. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤—Å–µ–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞–º–∏.|

---
### ‚öôÔ∏è **ResponseCompressionOptions**
–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å–∂–∞—Ç–∏—è.

```csharp
builder.Services.AddResponseCompression(options =>
{
    options.EnableForHttps = true;
    options.Providers.Add<BrotliCompressionProvider>(); // Brotli - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ (–º–æ–∂–Ω–æ –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å —è–≤–Ω–æ –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –µ–≥–æ)
    options.Providers.Add<GzipCompressionProvider>();
});
```

–°–≤–æ–π—Å—Ç–≤–∞:
- `EnableForHttps` ‚Äî —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Å–∂–∞—Ç–∏–µ –ø—Ä–∏ HTTPS.
- `MimeTypes` ‚Äî —Å–ø–∏—Å–æ–∫ MIME-—Ç–∏–ø–æ–≤ –¥–ª—è —Å–∂–∞—Ç–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ).
	```csharp
	options.MimeTypes = new[] { "text/plain", "text/css", "application/javascript" };
	```
- `Providers` ‚Äî —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (Brotli, Gzip –∏ –¥—Ä.).

---
### üóúÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Ä–æ–≤–Ω—è —Å–∂–∞—Ç–∏—è

–ó–Ω–∞—á–µ–Ω–∏—è `CompressionLevel`:
- `Optimal` ‚Äî –ª—É—á—à–µ–µ —Å–∂–∞—Ç–∏–µ (–Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ).
- `Fastest` ‚Äî –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –º–µ–Ω—å—à–µ —ç—Ñ—Ñ–µ–∫—Ç.
- `NoCompression` ‚Äî –æ—Ç–∫–ª—é—á–∞–µ—Ç —Å–∂–∞—Ç–∏–µ.

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Ä–æ–≤–Ω—è –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ –¥–ª—è Gzip –∏ Brotli:
```csharp
builder.Services.Configure<BrotliCompressionProviderOptions>(options =>
{
    options.Level = CompressionLevel.Fastest;
});

builder.Services.Configure<GzipCompressionProviderOptions>(options =>
{
    options.Level = CompressionLevel.Optimal;
});
```

---
### üîß <font color="#ffff00">**–°–≤–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Å–∂–∞—Ç–∏—è - `ICompressionProvider`**</font>

```csharp
public interface ICompressionProvider
{
    string EncodingName { get; }
    bool SupportsFlush { get; }
    Stream CreateStream(Stream outputStream);
}
```

---
##### **–ü—Ä–∏–º–µ—Ä:**

```csharp
public class CustomCompressionProvider : ICompressionProvider
{
	public string EncodingName => "custom";
	public bool SupportsFlush => true;

	public Stream CreateStream(Stream outputStream)
	{
		// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–≤–æ–µ–≥–æ —Å–∂–∞—Ç–∏—è
		//return outputStream; // –ø—Ä–∏–º–µ—Ä –±–µ–∑ —Å–∂–∞—Ç–∏—è
		return new CustomCompressionStream(outputStream);
	}
}
```
–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:
```csharp
options.Providers.Add<CustomCompressionProvider>();
```

–í –ø—Ä–∏–º–µ—Ä–µ `CustomCompressionStream` ‚Äî —ç—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø–æ—Ç–æ–∫ (`Stream`), –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–∂–∞—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞. 
–û–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å—Å—è –æ—Ç `Stream` –∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –µ–≥–æ –º–µ—Ç–æ–¥—ã.

###### üìå **–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `CustomCompressionStream`**

üîç **–†–∞–∑–±–æ—Ä –∫–æ–¥–∞**
- –ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –∑–∞–ø–∏—Å—å (`CanWrite = true`, `CanRead = false`).
- –ú–µ—Ç–æ–¥ `Write()` –∏–∑–º–µ–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ `_outputStream` (–∏–º–∏—Ç–∞—Ü–∏—è —Å–∂–∞—Ç–∏—è).
- –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —á—Ç–µ–Ω–∏–µ–º/–ø–æ–∏—Å–∫–æ–º, –≤—ã–±—Ä–∞—Å—ã–≤–∞—é—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è.

```csharp
public class CustomCompressionStream : Stream
{
    private readonly Stream _outputStream;

    public CustomCompressionStream(Stream outputStream)
    {
        _outputStream = outputStream;
    }

    public override bool CanRead => false;
    public override bool CanSeek => false;
    public override bool CanWrite => true;
    public override long Length => throw new NotSupportedException();
    public override long Position { get => throw new NotSupportedException(); set => throw new NotSupportedException(); }

    public override void Flush() => _outputStream.Flush();

    public override int Read(byte[] buffer, int offset, int count) => throw new NotSupportedException();

    public override long Seek(long offset, SeekOrigin origin) => throw new NotSupportedException();

    public override void SetLength(long value) => throw new NotSupportedException();

    public override void Write(byte[] buffer, int offset, int count)
    {
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É —Å–∂–∞—Ç–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, XOR-—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ (–∫–∞–∫ –ø—Ä–∏–º–µ—Ä)
        for (int i = offset; i < offset + count; i++)
        {
            buffer[i] ^= 0xAA; // –ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ (–ø—Ä–∏–º–µ—Ä)
        }
        _outputStream.Write(buffer, offset, count);
    }
}
```

---
### Outer links:
https://metanit.com/sharp/aspnet6/17.3.php