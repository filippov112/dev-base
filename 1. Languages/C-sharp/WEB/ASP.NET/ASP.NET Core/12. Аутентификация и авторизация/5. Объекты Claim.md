#Csharp #ASP

# 5. Объекты Claim в ASP.NET Core

> Для хранения различных данных пользователя во фреймворке ASP.NET Core определяются **объекты `claim`**.
> Класс `Claim`
> Пространство `System.Security.Claims`
> 
> **Свойства:**
> - `Issuer`: "издатель" или название системы, которая выдала данный объект
> - `Subject`: информация о пользователе в виде объекта `ClaimsIdentity`
> - `Type`: тип объекта (назначение)
> - `Value`: значение объекта

Пример одного из конструкторов:
```csharp
public Claim(string type, string value)
var usernameClaim = new Claim(ClaimTypes.Name, "Tom"); // можно использовать встроенные константы, типа `ClaimTypes.Name`, которая имеет значение "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name" и которая обычно применяется для установки имени пользователя (то, что потом мы сможем получить через свойство HttpContext.User.Identity.Name
```

Коллекцию объектов можно передать конструктору `ClaimsIdentity`:
```csharp
var usernameClaim = new Claim(ClaimTypes.Name, "Tom");
var claims = new List<Claim> { usernameClaim };
var claimsIdentity = new ClaimsIdentity(claims, "Cookies");
```

> Если мы динамически решим добавить новый claim или удалить существующий, то после изменения claim необходимо заново пересоздавать объект ClaimsPrincipal и перезаписывать аутентификационные куки или jwt-токен, где эти данные храняться.

### Управление объектами Claim

**Cвойства и методы `ClaimsPrincipal`:**
- `Claims`: набор ассоциированных с пользователем объектов
- `FindAll(type)` / `FindAll(predicate)`:  все объекты, которые соответствуют определенному типу или условию
- `FindFirst(type)` / `FindFirst(predicate)`: первый объект, который соответствуют определенному типу или условию
- `HasClaim(type, value)` / `HasClaim(predicate)`: имеет ли пользователь определенного типа с определенным значением
- `IsInRole(name)`: принадлежит ли пользователь роли с названием `name`

**Свойства и методы `ClaimsIdentity`:**
- `Claims`: свойство, которое возвращает набор ассоциированных с пользователем объектов
- `AddClaim(claim)`: добавляет для пользователя объект
- `AddClaims(claims)`: добавляет набор объектов
- `FindAll(type)` / `FindAll(predicate)`: возвращает все объекты, которые соответствуют определенному типу или условию
- `FindFirst(type)` / `FindFirst(predicate)`: возвращает первый объект, который соответствуют определенному типу или условию
- `HasClaim(predicate)`: возвращает значение `true`, если пользователь имеет объект, соответствующий определенному условию
- `RemoveClaim(claim)`: удаляет объект
- `TryRemoveClaim(claim)`: удаляет объект и возвращает `true` при успешном удалении

### Пример

```csharp
using Microsoft.AspNetCore.Authentication.Cookies;
using System.Security.Claims;
using Microsoft.AspNetCore.Authentication;
 
var builder = WebApplication.CreateBuilder();
 
builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie();
 
var app = builder.Build();
 
app.UseAuthentication();
 
app.MapGet("/login", async (HttpContext context) =>
{
    var username = "Tom";
    var company = "Microsoft";
    var phone = "+12345678901";
 
    var claims = new List<Claim> 
    { 
        new Claim (ClaimTypes.Name, username),
        new Claim ("company", company),
        new Claim(ClaimTypes.MobilePhone,phone)
    };
    var claimsIdentity = new ClaimsIdentity(claims, "Cookies");
    var claimsPrincipal = new ClaimsPrincipal(claimsIdentity);
    await context.SignInAsync(claimsPrincipal);
    return Results.Redirect("/");
});
app.Map("/", (HttpContext context) =>
{
    // аналогично var username = context.User.Identity.Name
    var username = context.User.FindFirst(ClaimTypes.Name);
    var phone = context.User.FindFirst(ClaimTypes.MobilePhone);
    var company = context.User.FindFirst("company");
    return $"Name: {username?.Value}\nPhone: {phone?.Value}\nCompany: {company?.Value}";
});
app.MapGet("/logout", async (HttpContext context) =>
{
    await context.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
    return "Данные удалены";
});
 
app.Run();
```

### Outer links:
https://metanit.com/sharp/aspnet6/13.6.php