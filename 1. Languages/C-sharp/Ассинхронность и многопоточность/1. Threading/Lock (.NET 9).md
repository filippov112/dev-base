#lang #lang-c_sharp 
# <font color="#00b0f0">C#:</font> Lock (.NET 9)

Более гибкий и производительный механизм синхронизации потоков по сравнению с `lock (obj)`.

**Плюсы:**
- <font color="#ffff00">Затраты памяти</font>: реализован через `struct Lock`, а не `class Monitor`.
- <font color="#ffff00">Ассинхронность</font>: поддерживает `await` (в отличие от `lock`).
- <font color="#ffff00">Реентерабельность</font>: когда один и тот же поток повторно запрашивает блокировку.
- <font color="#ffff00">Неблокирование</font>: может работать без блокировки основного потока.
- <font color="#ffff00">Производительность</font>: использует механизмы оптимизированного ожидания (`spin-wait` + `Monitor`), что снижает блокировки при коротких критических секциях.

**Когда используется:**
- Заменяет `SemaphoreSlim` в большинстве сценариев, упрощая код.

### Способы работы с классом:

1. **`lock`**
	- `lock (locker) {}` — гарантирует, что только один поток выполнит блок кода.
	```csharp
	Lock _lockObj = new();
	
	lock (_lockObj)
	{
		//...
	}
	```
---
2. **`Enter()`** - Аналог `lock`, но с явным управлением блокировкой:
	- `Enter()` — блокирует ресурс.  
	- `Exit()` — освобождает блокировку.
	```csharp
	Lock _lockObj = new(); // объект-заглушка для синхронизации доступа
	 
	_lockObj.Enter();;  // начало критической секции
	try
	{
		//...
	}  
	finally 
	{ 
		_lockObj.Exit(); // завершение критической секции
	} 
	```
---
3. **`TryEnter()`** - Позволяет задать таймаут для попытки блокировки:
	- Если `TryEnter()` не успевает захватить блокировку за указанное время, он пропускает выполнение критической секции.
	```csharp
	Lock myLock = new Lock();
	
	if (myLock.TryEnter(TimeSpan.FromSeconds(1)))
	{
	    try
	    {
	        // Критическая секция
	    }
	    finally
	    {
	        myLock.Exit();
	    }
	}
	else
	{
	    // Не удалось получить блокировку в течение 1 секунды
	}
	```
---
4.  **`Monitor.EnterScope()`**
	 - `Monitor.EnterScope(locker)` работает как `lock`, но освобождает блокировку автоматически при выходе из `using`.
	```csharp
	Lock myLock = new Lock();
	
	using (myLock.EnterScope())
	{
	    // Критическая секция
	}
	// Блокировка автоматически освобождается здесь
	```

### Outer links:
https://metanit.com/sharp/tutorial/11.10.php