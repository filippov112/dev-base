#lang #lang-c_sharp
# <font color="#00b0f0">C#:</font> Source Generators


**Source Generators (генераторы кода)** — (.NET 5) это инструменты, которые автоматически создают исходный код на основе определённых входных данных или шаблонов. 
1. автоматизация создания кода
2. уменьшение рутинных задач
3. повышение производительности.


---
Представляет собой класс, реализующий интерфейс `Microsoft.CodeAnalysis.ISourceGenerator`, и помеченный атрибутом `[Generator]`.

- **`Initialize(GeneratorInitializationContext context)`** - Выполняет инициализацию генератора перед началом работы.
  - `context` - для регистрации обработчиков событий или других настроек.
- **`Execute(GeneratorExecutionContext context)`** - Выполняет основную логику генерации кода.
  - `context` - для добавления сгенерированного кода в процесс компиляции.

Просмотр сгенерированных файлов - В Visual Studio: `Dependencies -> Analyzers -> GeneratorsLib`.

```csharp
using Microsoft.CodeAnalysis;

[Generator]
public class MySourceGenerator : ISourceGenerator
{
    public void Execute(GeneratorExecutionContext context)
    {
        throw new NotImplementedException();
    }

    public void Initialize(GeneratorInitializationContext context)
    {
        throw new NotImplementedException();
    }
}
```

---
#### Создание библиотеки для Source Generators

##### **1. Настройка проекта**
1. **Создание проекта**:
   - Создается проект библиотеки классов (например, `GeneratorsLib`).
2. **Добавление NuGet-пакетов**:
   - Устанавливаются пакеты:
     - `Microsoft.CodeAnalysis.Analyzers`
     - `Microsoft.CodeAnalysis.CSharp`
3. **Настройка `.csproj` файла**:
   - Целевой фреймворк - `netstandard2.0`.
     ```xml
     <Project Sdk="Microsoft.NET.Sdk">
       <PropertyGroup>
         <TargetFramework>netstandard2.0</TargetFramework>
       </PropertyGroup>
       <ItemGroup>
         <PackageReference Include="Microsoft.CodeAnalysis.Analyzers" Version="3.3.3">
           <PrivateAssets>all</PrivateAssets>
           <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
         </PackageReference>
         <PackageReference Include="Microsoft.CodeAnalysis.CSharp" Version="4.4.0" />
       </ItemGroup>
     </Project>
     ```

##### **2. Реализация генератора**
Пример простого генератора:
```csharp
using Microsoft.CodeAnalysis;

namespace GeneratorsLib
{
    [Generator]
    public class MySourceGenerator : ISourceGenerator
    {
        public void Execute(GeneratorExecutionContext context)
        {
            // Генерируемый код
            var code = @"
            namespace Metanit
            {
                public static class Welcome 
                {
                    public const string Name = ""Eugene"";
                    public static void Print() => Console.WriteLine($""Hello {Name}!"");
                }
            }";

            // Добавляем сгенерированный код в контекст компиляции
            context.AddSource("metanit.welcome.generated.cs", code);
        }

        public void Initialize(GeneratorInitializationContext context)
        {
            // Инициализация не требуется
        }
    }
}
```

##### **3. Подключение к проекту**
1. **Добавление ссылки**:
   - В проект приложения добавляется ссылка на библиотеку с генератором.
     ```xml
     <ItemGroup>
       <ProjectReference Include="..\Путь_к_проекту_библиотеки_классов\GeneratorsLib.csproj"
                         OutputItemType="Analyzer" 
                         ReferenceOutputAssembly="false" />
     </ItemGroup>
     ```
   - Атрибуты:
     - `OutputItemType="Analyzer"`: указывает, что проект является анализатором.
     - `ReferenceOutputAssembly="false"`: исключает библиотеку из сборки консольного приложения.

2. **Использование сгенерированного кода**:
   - В файле `Program.cs` вызывается сгенерированный код:
     ```csharp
     Metanit.Welcome.Print();
     ```

---
### Outer links:
- https://metanit.com/sharp/dotnet/4.1.php