#lang #lang-c_sharp
# <font color="#00b0f0">C#:</font> Внедрение зависимостей (DI)

**Dependency Injection (DI, внедрение зависимостей)** — механизм, позволяющий сделать компоненты программы слабосвязанными, повышая гибкость, адаптивность и расширяемость кода.  
**IoC-контейнеры (Inversion of Control)** - инструмент управления зависимостями в больших приложениях.

Проблема без DI:  
- Жёсткая привязка классов к конкретным реализациям.  
- Сложность замены зависимостей.  
- Трудности тестирования и управления зависимостями в больших проектах.  

**Пример без DI:**  
```csharp
class Logger  
{  
    SimpleLogService logService = new SimpleLogService();  //`Logger` жёстко зависит от `SimpleLogService`. 
    public void Log(string message) => logService.Write(message);  
}  
```  

**Решение с DI:**  
```csharp
interface ILogService { void Write(string message); }  

class Logger  
{  
    ILogService logService;  //Создание абстракции (`ILogService`)
    public Logger(ILogService logService) => this.logService = logService;  //Передача зависимости через конструктор. 
    public void Log(string message) => logService.Write(message);  
}  
```  

---
#### IoC-контейнер  - `IServiceProvider`

1. **Установка пакета:**  
   ```bash
   Install-Package Microsoft.Extensions.DependencyInjection
   ```  
2. **Добавление сервисов в контейнер:**  
   ```csharp
   var services = new ServiceCollection()  
       .AddTransient<ILogService, SimpleLogService>()  
       .AddTransient<Logger>();  
   ```  
   - `AddTransient`: новый экземпляр при каждом запросе.  
   - `AddSingleton`: один экземпляр на всё приложение.  
   - `AddScoped`: один экземпляр в рамках области (например, HTTP-запроса).  

3. **Получение сервисов:**  
	```csharp
	using var serviceProvider = services.BuildServiceProvider();  
	var logger = serviceProvider.GetService<Logger>();  
	logger?.Log("Hello DI!");  
	```  
	- Контейнер сам разрешает зависимости, передавая их через конструктор сервисов:  
	```csharp
	class Logger  
	{  
	    public Logger(ILogService logService) { ... }  
	}  
	
	// Регистрация:  
	services.AddTransient<ILogService, SimpleLogService>();  
	services.AddTransient<Logger>();  
	
	// Получение Logger с автоматическим внедрением ILogService:  
	var logger = serviceProvider.GetService<Logger>();  
	```  

---
### Outer links:
- https://metanit.com/sharp/dotnet/1.1.php