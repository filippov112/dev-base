#lang #lang-c_sharp
# <font color="#00b0f0">C#:</font> Worker-сервисы

**Worker-сервисы** — это фоновые приложения для задач без взаимодействия с пользователем.

---

#### **Создание**

1. ==**Инструменты для создания проекта**==
	- Visual Studio: Используется шаблон `Worker Service`.
	- .NET CLI:
	    ```bash
	    dotnet new worker
	    ```
	<br>
2. ==**Особенности структуры проекта**==
	- `Worker.cs`: класс сервиса, реализующий логику работы.
	<br>
3. ==**Файл конфигурации проекта `.csproj`**==
	  - `Sdk="Microsoft.NET.Sdk.Worker"`: указывает, что проект предназначен для создания сервисов.
	  - `<PackageReference>`: добавлен пакет `Microsoft.Extensions.Hosting` - позволяет развертывать и запускать сервисы.
	  - `<UserSecretsId>` - секретный код для текущего проекта
	```xml
	<Project Sdk="Microsoft.NET.Sdk.Worker">
	  <PropertyGroup>
	    <TargetFramework>net8.0</TargetFramework>
	    <Nullable>enable</Nullable>
	    <ImplicitUsings>enable</ImplicitUsings>
	    <UserSecretsId>dotnet-WorkerServiceApp-21388fcc-d283-4fc4-ab25-5dfa3ffcbfb3</UserSecretsId>
	  </PropertyGroup>
	  <ItemGroup>
	    <PackageReference Include="Microsoft.Extensions.Hosting" Version="8.0.0" />
	  </ItemGroup>
	</Project>
	```
	<br>
4. ==**Реализация сервиса - Класс `Worker`**==
	- Сервис должен реализовать **интерфейс `IHostedService`**. 
	- По умолчанию используется базовый класс `BackgroundService`, который предоставляет готовую реализацию `IHostedService`.
	-  `ExecuteAsync`: содержит логику работы сервиса.

	```csharp
	public class Worker : BackgroundService
	{
	    private readonly ILogger<Worker> _logger;
	
	    public Worker(ILogger<Worker> logger)
	    {
	        _logger = logger;
	    }
	
	    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
	    {
	        while (!stoppingToken.IsCancellationRequested)
	        {
	            _logger.LogInformation("Worker running at: {time}", DateTimeOffset.Now);
	            await Task.Delay(1000, stoppingToken);
	        }
	    }
	}
	```
	<br>
5. ==**Запуск сервиса**==

	```csharp
	//`Program.cs`
	using WorkerServiceApp;
	
	IHost host = Host.CreateDefaultBuilder(args) // создает объект `IHostBuilder`
	    .ConfigureServices(services =>
	    {
	        services.AddHostedService<Worker>(); // регистрирует сервис как синглтон
	    })
	    .Build(); // Построение хоста
	
	host.Run(); // запускает хост и все зарегистрированные сервисы.
	```

---
### Outer links:
- https://metanit.com/sharp/dotnet/3.1.php