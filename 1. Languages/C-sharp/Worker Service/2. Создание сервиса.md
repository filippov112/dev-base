#csharp
# <font color="#00b0f0">C#:</font> Создание сервиса

Для создания фоновых сервисов используются:

---
#### **Интерфейс `IHostedService`**

- **`StartAsync(CancellationToken cancellationToken)`**:
  - Вызывается при запуске сервиса.
  - Содержит логику инициализации и запуска фоновой задачи.
- **`StopAsync(CancellationToken cancellationToken)`**:
  - Вызывается при завершении работы приложения.
  - Содержит логику завершения задачи и освобождения ресурсов.
  - **Важно**: если приложение завершается аварийно, метод `StopAsync` может не вызываться.

---

#### **Класс `BackgroundService`**
Абстрактный класс, который реализует интерфейс `IHostedService`.
Упрощает создание фоновых задач, автоматически управляет жизненным циклом сервиса.

- `ExecuteAsync(CancellationToken stoppingToken)` - содержит основную логику фонового выполнения (вызывается внутри `StartAsync`)



---
### На основе `BackgroundService`
```csharp
// Пример сервиса `FileWatcherService`, который отслеживает изменения в папке:
public class FileWatcherService : BackgroundService
{
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        var filePath = "folderEvents.txt";
        using var watcher = new FileSystemWatcher("D:\\Temp");

        // Подписываемся на события файловой системы
        watcher.Changed += async (o, e) => await File.AppendAllTextAsync(filePath, $"{DateTime.Now} Changed: {e.FullPath}\n");
        watcher.Created += async (o, e) => await File.AppendAllTextAsync(filePath, $"{DateTime.Now} Created: {e.FullPath}\n");
        watcher.Deleted += async (o, e) => await File.AppendAllTextAsync(filePath, $"{DateTime.Now} Deleted: {e.FullPath}\n");
        watcher.Renamed += async (o, e) => await File.AppendAllTextAsync(filePath, $"{DateTime.Now} Renamed: {e.OldFullPath} to {e.FullPath}\n");
        watcher.Error += async (o, e) => await File.AppendAllTextAsync(filePath, $"{DateTime.Now} Error: {e.GetException().Message}\n");

        // Настройки
        watcher.IncludeSubdirectories = true; // Отслеживать подкаталоги
        watcher.EnableRaisingEvents = true;   // Включить события

        // Цикл выполнения
        while (!stoppingToken.IsCancellationRequested)
        {
            await Task.Delay(200, stoppingToken);
        }
    }
}
```

```csharp
// Регистрация сервиса в хосте:
IHost host = Host.CreateDefaultBuilder(args)
    .ConfigureServices(services =>
    {
        services.AddHostedService<FileWatcherService>();
    })
    .Build();

host.Run();
```

---
### На основе `IHostedService`
```csharp
public class FileWatcherService2 : IHostedService
{
    private FileSystemWatcher? watcher;
    private string filePath = "folderEvents.txt";

    public async Task StartAsync(CancellationToken cancellationToken)
    {
        watcher = new FileSystemWatcher("D:\\Temp");

        // Подписываемся на события файловой системы
        watcher.Changed += async (o, e) => await File.AppendAllTextAsync(filePath, $"{DateTime.Now} Changed: {e.FullPath}\n");
        watcher.Created += async (o, e) => await File.AppendAllTextAsync(filePath, $"{DateTime.Now} Created: {e.FullPath}\n");
        watcher.Deleted += async (o, e) => await File.AppendAllTextAsync(filePath, $"{DateTime.Now} Deleted: {e.FullPath}\n");
        watcher.Renamed += async (o, e) => await File.AppendAllTextAsync(filePath, $"{DateTime.Now} Renamed: {e.OldFullPath} to {e.FullPath}\n");
        watcher.Error += async (o, e) => await File.AppendAllTextAsync(filePath, $"{DateTime.Now} Error: {e.GetException().Message}\n");

        // Настройки
        watcher.IncludeSubdirectories = true;
        watcher.EnableRaisingEvents = true;

        await Task.CompletedTask;
    }

    public async Task StopAsync(CancellationToken cancellationToken)
    {
        watcher?.Dispose();
        await Task.CompletedTask;
    }
}
```

Регистрация сервиса в хосте аналогична предыдущему примеру

---
### Outer links:
- https://metanit.com/sharp/dotnet/3.2.php