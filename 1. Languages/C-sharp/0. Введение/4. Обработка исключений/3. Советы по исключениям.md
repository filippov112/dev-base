#Csharp

# Советы по исключениям в C#

#### 1. Использование `throw`
Использование `throw;` сохраняет исходный стек-трейс.
**Неправильно**:
  ```csharp
  try
  {
      try
      {
          // Код, который может сгенерировать исключение SpecificException
      }
      catch (SpecificException specificException)
      {
          log.LogError(specificException, "Specific error");
      }
      // Другой код
  }
  catch (Exception exception)
  {
      log.LogError(exception, "General error");
  }
  ```

**Правильно**:
  ```csharp
  catch (SpecificException specificException)
  {
      // ...
      throw;
  }
  ```

---
#### 2. Использование `Data` словаря исключения
Идея: Добавлять дополнительную информацию в исключения через словарь `Data`.

```csharp
var exception = new Exception("An error happened");
exception.Data.Add("user", Thread.CurrentPrincipal.Identity.Name);
throw exception;
```

```csharp
try
{
  service.SomeCall();
}
catch (Exception e)
{
  e.Data.Add("user", Thread.CurrentPrincipal.Identity.Name);
  throw;
}
```
---
#### 3. Сначала специфические исключения
Проблема: Простое перехватывание общего `Exception`.
Решение: Перехватывать специфические исключения в первую очередь.

```csharp
try
{
  File.WriteAllText(path, contents);
}
catch (ArgumentException ae)
{
  Message.Show("Invalid path");
}
catch (DirectoryNotFoundException dnfe)
{
  Message.Show("Directory not found");
}
catch (Exception e)
{
  var supportId = Guid.NewGuid();
  e.Data.Add("Support id", supportId);
  logger.Error(e);
  Message.Show($"Please contact support with id: {supportId}");
}
```
---
#### 4. Чем меньше исключений - тем лучше
Подход: Использовать защитное программирование для предотвращения исключений.
Для предотвращения `NullReferenceException`:

```csharp
Address a = null;
var city = a?.City;
```

Для предотвращения `FormatException` при разборе чисел:

```csharp
if (int.TryParse("invalid", out int i))
{
}
```
---
#### 5. Использование пользовательских исключений
Причина: Больше возможностей для специфической обработки исключений.

```csharp
public class MyVerySpecializedException : Exception
{
  public MyVerySpecializedException() : base() {}
  public MyVerySpecializedException(string message) : base(message) {}
  public MyVerySpecializedException(string message, Exception inner) : base(message, inner) {}
  public int Status { get; set; }
}
```

```csharp
try
{
  service.SomeCall();
}
catch (MyVerySpecializedException e) when (e.Status == 500)
{
  // Do something specific for Status 500
}
catch (MyVerySpecializedException ex)
{
  // Do something general
}
```
---
#### 6. Логирование исключений
Совет: Логировать как неперехваченные, так и перехваченные исключения.
Инструменты: **NLog, Serilog, elmah.io** для автоматического логирования в ASP.NET (Core).

```csharp
try
{
  service.SomeCall();
}
catch
{
  // Игнорируется - плохая практика
}
```


### Inner links:
[1. Исключения (Exceptions)](1.%20Languages/C-sharp/0.%20Введение/4.%20Обработка%20исключений/1.%20Исключения%20(Exceptions).md)


### Outer links:


