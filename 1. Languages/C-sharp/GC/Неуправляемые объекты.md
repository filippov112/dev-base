#lang #lang-c_sharp 
# <font color="#00b0f0">C#:</font> Неуправляемые объекты

**<font color="#ffff00">Неуправляемые объекты</font>** - неподконтрольные сборщику мусора.
Примеры объектов: подключения к файлам, базам данных, сетевые подключения и т.д.

**Способы** освобождения ресурсов неуправляемых объектов:

---
#### 1. Деструктор
**<font color="#ffff00">Деструктор</font>** - переопределенние метода `Finalize` базового класса `Object`, вызываемого сборщиком мусора.
- только в классах
- НЕ вызываются автоматически при завершении программы (.NET 5+).
- снижают производительность.

```csharp
class Person
{
    ~Person()
    {
        //...
    }
}
```

**Как работает добавление деструктора?**
Указатель на объект с деструктором сохраняется в <font color="#de7802">очередь финализации</font>
В момент сборки мусора, такой объект копируется в отдельную таблицу, откуда будет удален лишь при повторном проходе сборщика.

Скомпилированный деструктор:
```csharp
protected override void Finalize()
{
    try
    {
        // здесь идут инструкции деструктора
    }
    finally
    {
        base.Finalize();
    }
}
```

---
#### 2. **`IDisposable`**
Интерфейс ручного освобождения неуправляемых ресурсов
```csharp
// Person tom = new Person("Tom");
//..
//finally
{
	tom?.Dispose();
}

public class Person : IDisposable
{
	// ...
    public void Dispose()
    {
        // ...
    }
}
```

- Используется конструцией `using`.
	```csharp
	using (Person tom = new Person("Tom"))
	{
	}
	```
	```csharp
	// C# 8.0 - На всю область видимости (в пределах блока)
	using Person tom = new Person("Tom");
	```

---

#### 3. Комбинирование подходов
`GC.SuppressFinalize(this)` - блокирует вызов деструктора для объекта с `Dispose` (ручным освобождением), из которого и вызывается.

Базовый шаблон комбинации 2-ух методов:
```csharp
public class SomeClass: IDisposable
{
    private bool disposed = false;
 
    // реализация интерфейса IDisposable.
    public void Dispose()
    {
        // освобождаем неуправляемые ресурсы
        Dispose(true);
        // отключаем деструктор
        GC.SuppressFinalize(this);
    }
 
    protected virtual void Dispose(bool disposing)
    {
        if (disposed) return;
        if (disposing) // Ручной запуск из Dispose(). Выполняем работу сборщика
        {
            // Освобождаем управляемые ресурсы
        }
        // освобождаем неуправляемые объекты
        disposed = true;
    }
 
    // Деструктор
    ~SomeClass()
    {
        Dispose (false);
    }
}
```

### Outer links:
https://metanit.com/sharp/tutorial/8.2.php
https://metanit.com/sharp/tutorial/8.5.php