#lang #lang-c_sharp 

---
Создание конфигурации вовлекает три компонента: 
- **IConfigurationSource** (определяет источник конфигурации), 
- **ConfigurationProvider** (сам провайдер конфигурации) и 
- некий класс, который добавляет **метод расширения** к объекту `IConfiguration`.

### 1. Провайдер конфигурации - `ConfigurationProvider`
1. Наследуемся от `ConfigurationProvider`. 
2. Переопределяем метод обновления данных - `Load()` в котором изменяем содержимое словаря `Data`.

```csharp
// пример:

public class TextConfigurationProvider : ConfigurationProvider
{
    //public string FilePath { get; set; }
    //public TextConfigurationProvider(string path)
    //{
    //    FilePath = path;
    //}
    public override void Load() // Переопределяем метод обновления данных из источника
    {
        //var data = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        //using (StreamReader textReader = new StreamReader(FilePath))
        //{
        //    string? line;
        //    while ((line = textReader.ReadLine()) != null)
        //    {
        //        string key = line.Trim();
        //        string? value = textReader.ReadLine() ?? "";
        //        data.Add(key, value);
        //    }
        //}
        Data = data; // Обновляем источник - свойство Data
    }
}
```

### 2. Источник конфигурации - `IConfigurationSource`
1. Реализуем интерфейс `IConfigurationSource`, его метод `Build`, который будет принимать в параметрах `IConfigurationBuilder` и давать на выходе созданный ранее провайдер.

```csharp
// пример:

public class TextConfigurationSource : IConfigurationSource
{
    //public string FilePath { get; }
    //public TextConfigurationSource(string filename)
    //{
    //    FilePath = filename;
    //}
    // необходимо реализовать Build
    public IConfigurationProvider Build(IConfigurationBuilder builder)
    {
        // получаем полный путь для файла
        //string filePath = builder.GetFileProvider().GetFileInfo(FilePath).PhysicalPath;
        return new TextConfigurationProvider(filePath);
    }
}
```

### 3. Метод расширения для подключения источника
1. Создаем источник.
2. Добавляем его в коллекцию строителя конфигурации.

```csharp
public static class TextConfigurationExtensions
{
    public static IConfigurationBuilder AddTextFile(
        this IConfigurationBuilder builder, string path)
    {
        //if (builder == null)
        //{
        //    throw new ArgumentNullException(nameof(builder));
        //}
        //if (string.IsNullOrEmpty(path))
        //{
        //    throw new ArgumentException("Путь к файлу не указан");
        //}
 
        var source = new TextConfigurationSource(path);
        builder.Add(source);
        return builder;
    }
}
```

### Проверка:

```csharp
builder.Configuration.AddTextFile("config.txt");
```


### Outer links:
https://metanit.com/sharp/aspnet6/6.6.php