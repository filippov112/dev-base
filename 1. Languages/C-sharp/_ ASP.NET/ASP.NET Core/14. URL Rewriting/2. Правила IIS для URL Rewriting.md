#lang #lang-c_sharp #aspnet 

---
### ### üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª IIS
–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ XML-—Ñ–∞–π–ª–∞ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ `web.config` (–∏–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–∑ IIS) —á–µ—Ä–µ–∑ `StreamReader`.

```csharp
using Microsoft.AspNetCore.Rewrite;
using Microsoft.Extensions.Hosting;

var env = app.Environment;

using var reader = File.OpenText(Path.Combine(env.ContentRootPath, "IISUrlRewrite.xml"));
var rewriteOptions = new RewriteOptions().AddIISUrlRewrite(reader);

app.UseRewriter(rewriteOptions);
```
–ò–ª–∏ —Ç–∞–∫:
```csharp
IHostEnvironment? env = app.Services.GetService<IHostEnvironment>();
if(env is not null)
{
    var options = new RewriteOptions()
                    .AddIISUrlRewrite(env.ContentRootFileProvider, "urlrewrite.xml");
    app.UseRewriter(options);
}
```

---
### üìÑ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ –ø—Ä–∞–≤–∏–ª–∞
–§–∞–π–ª –ø—Ä–∞–≤–∏–ª –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ `web.config` –∏ –≤–∫–ª—é—á–∞–µ—Ç:

```xml
<rewrite>
  <rules>
    <rule name="SampleRule" stopProcessing="true">
      <match url="^old-path/(.*)" />
      <conditions>
        <add input="{HTTP_HOST}" pattern="^example\.com$" />
      </conditions>
      <action type="Redirect" url="/new-path/{R:1}" redirectType="Permanent" />
    </rule>
  </rules>
</rewrite>
```

–≠–ª–µ–º–µ–Ω—Ç—ã:
- `<rule>` ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ.
- `<match>` ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–æ–π URL –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å.
- `<conditions>` ‚Äî —É—Å–ª–æ–≤–∏—è, –ø—Ä–∏ –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª–æ.
- `<action>` ‚Äî —á—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏.

---
### üîç Conditions (—É—Å–ª–æ–≤–∏—è)

–£—Å–ª–æ–≤–∏—è (`<conditions>`) —É—Ç–æ—á–Ω—è—é—Ç, –∫–æ–≥–¥–∞ –ø—Ä–∞–≤–∏–ª–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è. –í–Ω—É—Ç—Ä–∏ ‚Äî –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ `<add>`:

```xml
<conditions>
  <add input="{HTTPS}" pattern="^OFF$" />
</conditions>
```

–ê—Ç—Ä–∏–±—É—Ç—ã `<add>`:
- `input` ‚Äî –∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è (—á–∞—Å—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å–µ—Ä–≤–µ—Ä–∞).
- `pattern` ‚Äî —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è.
- `matchType` (–Ω–µ–æ–±—è–∑.) ‚Äî `Pattern` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) –∏–ª–∏ `IsFile`, `IsDirectory`.
- `ignoreCase` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `true`).
- `negate` ‚Äî –ª–æ–≥–∏—á–µ—Å–∫–æ–µ –æ—Ç—Ä–∏—Ü–∞–Ω–∏–µ (`true`/`false`).

---

### üéØ Actions (–¥–µ–π—Å—Ç–≤–∏—è)

–≠–ª–µ–º–µ–Ω—Ç `<action>` –æ–ø–∏—Å—ã–≤–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ `match` –∏ `conditions` –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.
–ê—Ç—Ä–∏–±—É—Ç—ã `<action>`:

- `type`:
    - `Rewrite` ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ø–æ–¥–º–µ–Ω–∞ URL.    
    - `Redirect` ‚Äî –≤–Ω–µ—à–Ω–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç.    
    - `AbortRequest` ‚Äî –∑–∞–≤–µ—Ä—à–∞–µ—Ç –∑–∞–ø—Ä–æ—Å (403).    
    - `CustomResponse` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å –∏ —Ç–µ–∫—Å—Ç.    
- `url` ‚Äî –Ω–æ–≤—ã–π –ø—É—Ç—å (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏).
- `redirectType` (–¥–ª—è `Redirect`) ‚Äî `Permanent`, `Found`, `SeeOther`, `Temporary`. 
- `statusCode`, `subStatusCode`, `statusReason`, `statusDescription` ‚Äî –¥–ª—è `CustomResponse`.

–ü—Ä–∏–º–µ—Ä:
```xml
<action type="Redirect" url="/new-path/{R:1}" redirectType="Permanent" />
```

---

### üß© –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞
–ú–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ `input`, `url`, `conditions`. –§–æ—Ä–º–∞—Ç: `{VARIABLE_NAME}`.

–ü—Ä–∏–º–µ—Ä—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:
- `{HTTP_HOST}` ‚Äî –¥–æ–º–µ–Ω.
- `{REQUEST_METHOD}` ‚Äî –º–µ—Ç–æ–¥ (GET/POST).
- `{REQUEST_URI}` ‚Äî –ø–æ–ª–Ω—ã–π –ø—É—Ç—å. 
- `{QUERY_STRING}` ‚Äî —Å—Ç—Ä–æ–∫–∞ –∑–∞–ø—Ä–æ—Å–∞.
- `{HTTPS}` ‚Äî `ON` –∏–ª–∏ `OFF`.
- `{REMOTE_ADDR}` ‚Äî IP –∫–ª–∏–µ–Ω—Ç–∞.
- `{HTTP_USER_AGENT}` ‚Äî User-Agent –±—Ä–∞—É–∑–µ—Ä–∞.
- `{HTTP_HEADER_NAME}` ‚Äî –ª—é–±–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ HTTP.

–ü—Ä–∏–º–µ—Ä —É—Å–ª–æ–≤–∏—è:
```xml
<add input="{HTTP_USER_AGENT}" pattern=".*Googlebot.*" />
```
URL –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–º –≤–∏–¥–µ:¬†`http(s)://<host>:<port>/<path>?<querystring>`

---

### üîÑ –û–±—Ä–∞—Ç–Ω—ã–µ —Å—Å—ã–ª–∫–∏

**–û–±—Ä–∞—Ç–Ω—ã–µ —Å—Å—ã–ª–∫–∏ (back-references)** ‚Äî —Å—Å—ã–ª–∫–∏ –Ω–∞ –≥—Ä—É–ø–ø—ã –∏–∑ `match` –∏–ª–∏ `conditions`.
–§–æ—Ä–º–∞—Ç:
- `{R:n}` ‚Äî –≥—Ä—É–ø–ø—ã –∏–∑ `match`, –≥–¥–µ `n` ‚Äî –Ω–æ–º–µ—Ä –≥—Ä—É–ø–ø—ã.
- `{C:n}` ‚Äî –≥—Ä—É–ø–ø—ã –∏–∑ `conditions`.
    
–ü—Ä–∏–º–µ—Ä:
```xml
<match url="^product/([0-9]+)" />
<action type="Rewrite" url="/catalog.aspx?id={R:1}" />
```

–ï—Å–ª–∏ –µ—Å—Ç—å —É—Å–ª–æ–≤–∏–µ:
```xml
<conditions>
  <add input="{HTTP_HOST}" pattern="^www\.([a-z]+)\.com$" />
</conditions>
<action type="Rewrite" url="/site/{C:1}/default.aspx" />
```

---
### Outer links:
https://metanit.com/sharp/aspnet6/15.2.php