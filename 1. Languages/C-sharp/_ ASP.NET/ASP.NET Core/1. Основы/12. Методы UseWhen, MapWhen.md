#lang #lang-c_sharp #aspnet

---
Создают ветвление конвейера обработки запроса в зависимости от условия.

```csharp
public static IApplicationBuilder UseWhen (this IApplicationBuilder app, Func<HttpContext,bool> predicate, Action<IApplicationBuilder> configuration);

public static IApplicationBuilder MapWhen (this IApplicationBuilder app, Func<HttpContext,bool> predicate, Action<IApplicationBuilder> configuration);
```

- Первый параметр - делегат `Func>HttpContext,bool>` - условие, которому должен соответствовать запрос для прохождения по ветке.
- Второй параметр - делегат `Action<IApplicationBuilder>` - действия над объектом `IApplicationBuilder`, (собственно подключение других компонентов).

> [!note] Примечание!
> Делегат `Action<IApplicationBuilder>` - выполняется только 1 раз - в момент запуска приложения. Любые действия повторяемые для запросов должны находиться в телах компонентов, которые подключаются внутри тела этого делегата.

**Пример:**
```csharp
var builder = WebApplication.CreateBuilder();
var app = builder.Build();
 
app.UseWhen(
    context => context.Request.Path == "/time", // если путь запроса "/time"
    appBuilder =>
    {
        // логгируем данные - выводим на консоль приложения
        appBuilder.Use(async (context, next) =>
        {
            var time = DateTime.Now.ToShortTimeString();
            Console.WriteLine($"Time: {time}");
            await next();   // вызываем следующий middleware
        });
 
        // отправляем ответ
        appBuilder.Run(async context =>
        {
            var time = DateTime.Now.ToShortTimeString();
            await context.Response.WriteAsync($"Time: {time}");
        });
});
 
app.Run(async context =>
{
    await context.Response.WriteAsync("Hello METANIT.COM");
});
 
app.Run();
```

### Outer links:
https://metanit.com/sharp/aspnet6/2.13.php