#lang #lang-c_sharp 

---
За обработку запросов в ASP отвечают **middleware-компоненты (MW)**. 
Вместе они составляют **конвеер обработки запросов**.
- **Inline middleware** - компоненты представляемые методами.
- *терминальные* компоненты - те которые не пропускают запрос дальше по конвееру.

![|400](heap/_files/Pasted%20image%2020241117121528.png)

#### **Особенности MW:**
- Существуют весь срок жизни приложения.
- Встраиваются с помощью методов расширений `Run`, `Map` и `Use` интерфейса `IApplicationBuilder` (реализуемого `WebApplication`).
	```csharp
	IApplicationBuilder.Run(RequestDelegate handler)
	```
	- Метод `Run()` - добавляет терминальные компоненты (конечный метод конвейера) - не путать с Run для запуска хоста!
	- [11. Метод Use](1.%20Languages/C-sharp/_%20ASP.NET/ASP.NET%20Core/1.%20Основы/11.%20Метод%20Use.md)
	- [12. Методы UseWhen, MapWhen](1.%20Languages/C-sharp/_%20ASP.NET/ASP.NET%20Core/1.%20Основы/12.%20Методы%20UseWhen,%20MapWhen.md)
	- [13. Метод Map](1.%20Languages/C-sharp/_%20ASP.NET/ASP.NET%20Core/1.%20Основы/13.%20Метод%20Map.md)

- Каждый может быть определен как метод (встроенный inline компонент), либо может быть вынесен в отдельный класс.
- Для создания используется делегат `RequestDelegate`, который выполняет некоторое действие и принимает контекст запроса - объект `HttpContext`: 
	```csharp
	public delegate Task RequestDelegate(HttpContext context);
	```

#### **Состав контекста запроса `HttpContext`:**
- `Connection`: представляет информацию о подключении
- `Features`: получает коллекцию HTTP-функциональностей
- `Items`: получает или устанавливает коллекцию пар ключ-значение для хранения некоторых данных
- `Request`: возвращает объект HttpRequest, который хранит информацию о текущем запросе
- `RequestAborted`: уведомляет приложение, когда подключение прерывается, и соответственно обработка запроса должна быть отменена
- `RequestServices`: получает или устанавливает объект IServiceProvider, который предоставляет доступ к контейнеру сервисов запроса
- `Response`: возвращает объект HttpResponse, который позволяет управлять ответом клиенту
- `Session`: хранит данные сессии
- `TraceIdentifier`: представляет уникальный идентификатор запроса для логов трассировки
- `User`: представляет пользователя
- `WebSockets`: возвращает объект для управления подключениями WebSocket


#### **Примеры встроенных middleware:**
Для подключения к конвееру в `IApplicationBuilder` определены методы расширения типа `UseXXX`.

```csharp
var builder = WebApplication.CreateBuilder();
var app = builder.Build();
app.UseWelcomePage();   // подключение WelcomePageMiddleware
app.Run();
```

- `Authentication`: предоставляет поддержку аутентификации
- `Authorization`: предоставляет поддержку авторизации
- `Cookie Policy`: отслеживает согласие пользователя на хранение связанной с ним информации в куках
- `CORS`: обеспечивает поддержку кроссдоменных запросов
- `DeveloperExceptionPage`: генерирует веб-страницу с информацией об ошибке при работе в режиме разработки
- `Diagnostics`: набор middleware, который предоставляет страницы статусных кодов, функционал обработки исключений, страницу исключений разработчика
- `Forwarded Headers`: перенаправляет заголовки запроса
- `Health Check`: проверяет работоспособность приложения asp.net core
- `Header Propagation`: обеспечивает передачу заголовков из HTTP-запроса
- `HTTP Logging`: логгирует информацию о входящих запросах и генерируемых ответах
- `HTTP Method Override`: позволяет входящему POST-запросу переопределить метод
- `HTTPS Redirection`: перенаправляет все запросы HTTP на HTTPS
- `HTTP Strict Transport Security (HSTS)`: для улучшения безопасности приложения добавляет специальный заголовок ответа
- `MVC`: обеспечивает функционал фреймворка MVC
- `OWIN`: обеспечивает взаимодействие с приложениями, серверами и компонентами, построенными на основе спецификации OWIN
- `Request Localization`: обеспечивает поддержку локализации
- `Response Caching`: позволяет кэшировать результаты запросов
- `Response Compression`: обеспечивает сжатие ответа клиенту
- `URL Rewrite`: предоставляет функциональность URL Rewriting
- `Endpoint Routing`: предоставляет механизм маршрутизации
- `Session`: предоставляет поддержку сессий
- `SPA`: обрабатывает все запросы, возвращая страницу по умолчанию для SPA-приложения (одностраничного приложения)
- `Static Files`: предоставляет поддержку обработки статических файлов
- `WebSockets`: добавляет поддержку протокола WebSockets
- `W3CLogging`: генерирует логи доступа в соответствии с форматом W3C Extended Log File Format

### Outer links:
https://metanit.com/sharp/aspnet6/2.2.php