#lang #lang-c_sharp 

---
Метод расширения `Use()` добавляет компонент middleware, который позволяет передать обработку запроса далее следующим в конвейере компонентам.
```csharp
public static IApplicationBuilder Use(this IApplicationBuilder app, Func<HttpContext, Func<Task>, Task> middleware);
public static IApplicationBuilder Use(this IApplicationBuilder app, Func<HttpContext, RequestDelegate, Task> middleware)
```

**Делегат Func**
- Первый параметр - объект HttpContext.
- Второй параметр - другой делегат - `Func<Task> `или `RequestDelegate`.Следующий в конвейере компонент middleware, которому будет передаваться обработка запроса.
	- Отличие между `Func<Task> `и `RequestDelegate` - в способе вызова - для `RequestDelegate` надо передавать контекст.

**Правила** 
- Компонент middleware должен либо генерировать ответ с помощью `Response.WriteAsync`, либо вызывать следующий делегат посредством `next.Invoke`, но не выполнять оба этих действия одновременно.
- Middleware в методе Use() необязательно должен вызывать к следующему в конвейере компоненту. Вместо этого он может завершить обработку запроса, т.е. быть подключать терминальный компонент (но по возможности производительнее использовать для этого `run`)

```csharp
app.Use(async (context, next) =>
{
    // действия перед передачи запроса в следующий middleware
    
    await next.Invoke();
    // await next.Invoke(context);
    
    // действия после обработки запроса следующим middleware
});
```

### Outer links:
https://metanit.com/sharp/aspnet6/2.7.php