#lang #lang-c_sharp #aspnet

---
**Класс middleware** должен иметь:
- конструктор, который принимает параметр типа `RequestDelegate`. Через него можно получить ссылку на следующий middleware в конвейере.
- метод, который должен называться либо `Invoke`, либо `InvokeAsync`. Должен возвращать объект `Task` и принимать в качестве параметра контекст запроса - объект `HttpContext`. Данный метод собственно и будет обрабатывать запрос.
Для добавления в конвейер применяется метод `UseMiddleware()`. [4. Методы расширения](1.%20Languages/C-sharp/0.%20Введение/2.%20Классовые%20механизмы/4.%20Методы%20расширения.md).
Можно оборачивать UseMiddleware() в метод расширения. 

> [!note] Примечание от себя!
Преимущество классов над методами в том, что они позволяют передавать в конструкторы дополнительные параметры для использования нескольких однотипных middleware без дублирования или создания кастомных функций оберток.

#### Пример
**Класс Middleware:**
```csharp
public class MyMiddleware
{
    private readonly RequestDelegate next;
  
    public MyMiddleware(RequestDelegate next)
    {
        this.next = next;
    }
  
    public async Task InvokeAsync(HttpContext context)
    {
        var token = context.Request.Query["token"];
        if (token!="12345678")
        {
            context.Response.StatusCode = 403;
            await context.Response.WriteAsync("Token is invalid");
        }
        else
        {
            await next.Invoke(context);
        }
    }
}
```

**Подключение к конвейеру:**
```csharp
var builder = WebApplication.CreateBuilder();
var app = builder.Build();
 
app.UseMiddleware<MyMiddleware>(); // <--
 
app.Run(async(context) => await context.Response.WriteAsync("Hello METANIT.COM"));
 
app.Run();
```

**Пример метода расширения для подключения компонента:**
```csharp
public static class TokenExtensions
{
    public static IApplicationBuilder UseToken(this IApplicationBuilder builder)
    {
        return builder.UseMiddleware<TokenMiddleware>();
    }
}

...

app.UseToken();
```

### Outer links:
https://metanit.com/sharp/aspnet6/2.15.php