#lang #lang-c_sharp 
# <font color="#00b0f0">ASP.NET:</font> Кастомные claims-политики авторизации

`IAuthorizationRequirement` используется для описания требования авторизации
`AuthorizationHandler` — обработчик для проверки, выполняется ли оно у текущего пользователя.

---
### ✅ Пример: требование — пользователь должен быть старше определённого возраста

1. Создание класса требования
	```csharp
	public class MinimumAgeRequirement : IAuthorizationRequirement
	{
	    public int MinimumAge { get; }
	
	    public MinimumAgeRequirement(int minimumAge)
	    {
	        MinimumAge = minimumAge;
	    }
	}
	```
2. Создание обработчика требования
	```csharp
	public class MinimumAgeHandler : AuthorizationHandler<MinimumAgeRequirement>
	{
	    protected override Task HandleRequirementAsync(
	        AuthorizationHandlerContext context,
	        MinimumAgeRequirement requirement)
	    {
	        // Получить claim "date_of_birth"
	        var dateOfBirthClaim = context.User.FindFirst(c => c.Type == ClaimTypes.DateOfBirth);
	        if (dateOfBirthClaim == null)
	            return Task.CompletedTask;
	
	        var dateOfBirth = DateTime.Parse(dateOfBirthClaim.Value);
	        var userAge = DateTime.Today.Year - dateOfBirth.Year;
	        if (dateOfBirth > DateTime.Today.AddYears(-userAge)) userAge--;
	
	        if (userAge >= requirement.MinimumAge)
	        {
	            context.Succeed(requirement); // Успешное выполнение требования
	        }
	
	        return Task.CompletedTask;
	    }
	}
	```
3. Регистрация обработчика и политики
	- [Зачем регистрировать AuthorizationHandler](heap/_/ASP/Зачем%20регистрировать%20AuthorizationHandler.md)
	- [Соотношение AuthorizationHandler-ов к требованиям (Requirements)](heap/_/ASP/Соотношение%20AuthorizationHandler-ов%20к%20требованиям%20(Requirements).md)
	```csharp
	builder.Services.AddAuthorization(options =>
	{
	    options.AddPolicy("Over18", policy =>
	        policy.Requirements.Add(new MinimumAgeRequirement(18)));
	});
	
	builder.Services.AddSingleton<IAuthorizationHandler, MinimumAgeHandler>();
	```

4. Применение политики
	```csharp
	[Authorize(Policy = "Over18")]
	public IActionResult AdultOnly()
	{
	    return View();
	}
	```

### Outer links:
https://metanit.com/sharp/aspnet6/13.9.php