#lang #lang-c_sharp 

---
ASP.NET Core позволяет полностью определить свою логику ведения лога.

#### 1. **Класс логгера** должен реализовать интерфейс `ILogger`:
- `BeginScope`: этот метод возвращает объект `IDisposable`, который представляет некоторую область видимости для логгера. 
- `IsEnabled`: доступен ли логгер для использования. 
- `Log`: этот метод предназначен для выполнения логгирования. Он принимает пять параметров:
	- `LogLevel`: уровень детализации текущего сообщения
	- `EventId`: идентификатор события
	- `TState`: некоторый объект состояния, который хранит сообщение
	- `Exception`: информация об исключении
	- `formatter`: функция форматирования, которая с помощью двух предыдущих параметов позволяет получить собственно сообщение для логгирования

#### 2. **Провайдер логгирования** должен реализовать интерфейс `ILoggerProvider`:
- `CreateLogger`: создает и возвращает объект логгера. 
- `Dispose`: управляет освобождение ресурсов. 

#### 3. **Метод расширения** для `ILoggingBuilder`, который будет добавлять провайдер логгирования.

```csharp
public class FileLogger : ILogger, IDisposable
{
    string filePath;
    static object _lock = new object();
    public FileLogger(string path)
    {
        filePath = path;
    }
    // В данном случае нам этот метод не важен, поэтому возвращаем значение `this` - ссылку на текущий объект класса, который реализует интерфейс `IDisposable`.
    public IDisposable BeginScope<TState>(TState state)
    {
        return this;
    }
 
    public void Dispose() { }
 
    public bool IsEnabled(LogLevel logLevel)
    {
        //return logLevel == LogLevel.Trace;
        return true;
    }
 
    public void Log<TState>(LogLevel logLevel, EventId eventId,
                TState state, Exception? exception, Func<TState, Exception?, string> formatter)
    {
        lock (_lock)
        {
            File.AppendAllText(filePath, formatter(state, exception) + Environment.NewLine);
        }
    }
}
```

```csharp
public class FileLoggerProvider : ILoggerProvider
{
    string path;
    public FileLoggerProvider(string path)
    {
        this.path = path;
    }
    public ILogger CreateLogger(string categoryName)
    {
        return new FileLogger(path);
    }
 
    public void Dispose() {}
}
```

```csharp
public static class FileLoggerExtensions
{
    public static ILoggingBuilder AddFile(this ILoggingBuilder builder, string filePath)
    {
        builder.AddProvider(new FileLoggerProvider(filePath));
        return builder;
    }
}
```

```csharp
var builder = WebApplication.CreateBuilder();
// устанавливаем файл для логгирования
builder.Logging.AddFile(Path.Combine(Directory.GetCurrentDirectory(), "logger.txt"));
// настройка логгирования с помошью свойства Logging идет до 
// создания объекта WebApplication
var app = builder.Build();
 
app.Run(async (context) =>
{
    app.Logger.LogInformation($"Path: {context.Request.Path}  Time:{DateTime.Now.ToLongTimeString()}");
    await context.Response.WriteAsync("Hello World!");
});
 
app.Run();
```




### Outer links:
https://metanit.com/sharp/aspnet6/7.4.php