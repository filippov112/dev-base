#lang #lang-c_sharp 

---
Фильтры запросов уровня модели (Model-level query filters) — это предикаты LINQ, определяемые в метаданных модели. 
Они автоматически применяются ко всем запросам LINQ, связанным с данной моделью.  
 
**Фильтр задается в `OnModelCreating` с помощью `HasQueryFilter()`.**  
```csharp
public class ApplicationContext : DbContext 
{
    public DbSet<User> Users { get; set; } = null!;
    public DbSet<Role> Roles { get; set; } = null!;
    public int RoleId { get; set; }  // Динамическое свойство для фильтра

    protected override void OnModelCreating(ModelBuilder modelBuilder) 
    {
        modelBuilder.Entity<User>().HasQueryFilter(u => u.Age > 17 && u.RoleId == RoleId);
	    // Возраст (`Age`) > 17.  
		// `RoleId` пользователя равен `RoleId` контекста данных. 
    }
}
```  
 
**Пример работы фильтра:**
```csharp
using (var db = new ApplicationContext() { RoleId = 2 }) 
{
    var users = db.Users.Include(u => u.Role).ToList();
	  // - Tom (17 лет, роль "user") — не проходит фильтр.
	  // - Bob (18 лет, роль "user") — не проходит, так как `RoleId` контекста = 2 (admin).
	  // - Alice (19 лет, роль "admin") — проходит.
	  // - Sam (20 лет, роль "admin") — проходит.
}
```  

---
#### **Особенности**  
- Фильтр применяется ко всем запросам, включая агрегатные функции:  
  ```csharp
  db.Users.Min(x => x.Age);  // Вернет 19 (а не 17).
  ```  
- **Отключение фильтра:** метод `IgnoreQueryFilters()`.  
  ```csharp
  db.Users.IgnoreQueryFilters().Min(x => x.Age);  // Вернет 17.
  ```  

---
### Outer links:
https://metanit.com/sharp/efcore/5.9.php