#lang #lang-c_sharp 

---
**Хранимые функции** — это функции, созданные в базе данных, которые можно вызывать из приложения через Entity Framework Core (EF Core).

##### Создание функции
  1. В **SQL Server Object Explorer** (Visual Studio) перейти в:  
     `Programmability → Functions → Table-valued Functions`.
  2. Создать новую функцию через контекстное меню (`Add New → Table-valued Function`).

##### Тестирование функции
  - Выполнить функцию через контекстное меню (`Execute Function`).
  - Указать параметр.
  - Убедиться, что возвращаются корректные данные.

---
#### Вызов функции
##### **Через SQL-запрос**
- Использование `FromSqlRaw` для вызова функции:
  ```csharp
  using (ApplicationContext db = new ApplicationContext())
  {
      SqlParameter param = new SqlParameter("@age", 30);
      var users = db.Users.FromSqlRaw("SELECT * FROM GetUsersByAge (@age)", param).ToList();
      foreach (var u in users)
          Console.WriteLine($"{u.Name} - {u.Age}");
  }
  ```

##### **Проецирование функции на метод контекста**
- **Добавление метода в контекст**:
  ```csharp
  public class ApplicationContext : DbContext
  {
      public IQueryable<User> GetUsersByAge(int age) => FromExpression(() => GetUsersByAge(age));

      protected override void OnModelCreating(ModelBuilder modelBuilder)
      {
          modelBuilder.HasDbFunction(() => GetUsersByAge(default));
      }
  }
  ```
  - `HasDbFunction` регистрирует метод как映射到 хранимой функции.
- **Использование**:
  ```csharp
  var users = db.GetUsersByAge(30); // Вызов хранимой функции
  foreach (var u in users)
      Console.WriteLine($"{u.Name} - {u.Age}");
  ```

---
### Outer links:
https://metanit.com/sharp/efcore/6.2.php