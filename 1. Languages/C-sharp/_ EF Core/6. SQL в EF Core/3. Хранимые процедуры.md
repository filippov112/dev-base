#lang #lang-c_sharp 

---
**Хранимые процедуры** позволяют выполнять предопределенные SQL-запросы на сервере.

Создание процедуры:
1. В **SQL Server Object Explorer** (Visual Studio) перейти в `Programmability → Stored Procedures`.
2. Нажать ПКМ → **Add New Stored Procedure**.
3. Обновление БД: Нажать **Update → Update Database**.

---
#### **`FromSqlRaw`**
- `FromSqlRaw` — для выборки данных в модели.
	- Параметры передаются через `SqlParameter`.
	- Синтаксис вызова: `"ИмяПроцедуры @параметр"`.

  ```csharp
  SqlParameter param = new("@name", "Microsoft");
  var users = db.Users.FromSqlRaw("GetUsersByCompany @name", param).ToList();
  ```

---
#### **`ExecuteSqlRaw`**
- `ExecuteSqlRaw` — для выполнения без возврата моделей (например, с OUTPUT-параметрами).
	- Параметр помечается как `ParameterDirection.Output`.
	- Для выполнения используется `db.Database.ExecuteSqlRaw()`.
	- Результат доступен в `param.Value`.

  ```sql
  CREATE PROCEDURE [dbo].[GetUserWithMaxAge]
      @name varchar(50) OUTPUT
  AS
      SELECT @name = [Name] FROM Users 
      WHERE Age = (SELECT MAX(Age) FROM Users)
  RETURN 0
  ```
  
  ```csharp
  using (ApplicationContext db = new ApplicationContext())
  {
      SqlParameter param = new()
      {
          ParameterName = "@userName",
          SqlDbType = System.Data.SqlDbType.VarChar,
          Direction = System.Data.ParameterDirection.Output,
          Size = 50
      };
      db.Database.ExecuteSqlRaw("GetUserWithMaxAge @userName OUT", param);
      Console.WriteLine(param.Value); // Получение выходного значения
  }
  ```

---
### Outer links:
https://metanit.com/sharp/efcore/6.3.php