#lang #lang-c_sharp 

---
Чтобы избежать конфликтов при одновременном редактировании данных несколькими пользователями существуют следующие решения:

**Токен параллелизма (concurrency token)** – свойство, которое EF Core проверяет перед сохранением изменений.  
Если значение токена изменилось, EF Core выбрасывает исключение `DbUpdateConcurrencyException`.  
Применяется **оптимистичный параллелизм** (optimistic concurrency) – конфликты обрабатываются только при сохранении.  

---
### Способы настройки токена параллелизма  

##### **Атрибут `[ConcurrencyCheck]`**  
  ```csharp
  public class User
  {
      public int Id { get; set; }
      [ConcurrencyCheck]
      public string? Name { get; set; }
  }
  ```  

##### **Метод `IsConcurrencyToken()` в Fluent API**  
  ```csharp
  modelBuilder.Entity<User>().Property(b => b.Name).IsConcurrencyToken();
  ```  

##### **Атрибут `[Timestamp]`**  
Специальное свойство (тип `byte[]`), которое автоматически обновляется при каждом изменении записи.  
EF Core включает его в SQL-условие `WHERE` при обновлении/удалении.  
**Важно:** Работает не во всех СУБД (например, в SQLite не поддерживается, но работает в MS SQL Server).  

  ```csharp
  public class User
  {
      public int Id { get; set; }
      public string? Name { get; set; }
      [Timestamp]
      public byte[]? Timestamp { get; set; }
  }
  ```  

##### **Метод `IsRowVersion()` в Fluent API**  
Аналог `[Timestamp]`, но настраивается через Fluent API.  

  ```csharp
  modelBuilder.Entity<User>().Property(b => b.Timestamp).IsRowVersion();
  ```  

---
### Обработка конфликтов  
 
  ```csharp
  try
  {
      User? user = db.Users.FirstOrDefault();
      if (user != null)
      {
          user.Name = "Bob";
          db.SaveChanges();
      }
  }
  catch (DbUpdateConcurrencyException ex)
  {
      Console.WriteLine("Данные были изменены другим пользователем!");
  }
  ```  

---
### Outer links:
https://metanit.com/sharp/efcore/2.11.php