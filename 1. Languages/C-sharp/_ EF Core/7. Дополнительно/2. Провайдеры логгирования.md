#lang #lang-c_sharp 
# <font color="#00b0f0">EF Core:</font> Провайдеры логгирования

**Провайдеры логгирования** — объекты, отвечающие за логику записи логов.  
Можно использовать встроенные провайдеры или создать собственные.  

---
#### **Настройка провайдера**  

- **Глобальная настройка (в контексте данных):**  
	```csharp
	public class ApplicationContext : DbContext
	{
	    public static readonly ILoggerFactory MyLoggerFactory = LoggerFactory.Create(builder =>
	    {
	        builder.AddProvider(new MyLoggerProvider()); // Кастомный
	        // builder.AddConsole(); // Встроенный - пакет `Microsoft.Extensions.Logging.Console`
	    });
	
	    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
	    {
	        optionsBuilder.UseLoggerFactory(MyLoggerFactory);
	    }
	}
	``` 

- **Локальное применение (в коде):**  
	```csharp
	using (var db = new ApplicationContext())
	{
	    db.GetService<ILoggerFactory>().AddProvider(new MyLoggerProvider()); // Кастомный
	    // операции с данными...
	}
	```  
 
---
#### **Создание своего провайдера**  
  
- **`ILoggerProvider`**:  
  - `CreateLogger()` — создает объект логгера.  
  - `Dispose()` — освобождает ресурсы.  

- **`ILogger`**:  
  - `BeginScope()` — определяет область видимости логгера.  
  - `IsEnabled()` — проверяет доступность логгера.  
  - `Log()` — выполняет запись лога (в файл, консоль и т. д.).  

```csharp
public class MyLoggerProvider : ILoggerProvider
{
    public ILogger CreateLogger(string categoryName) => new MyLogger();
    public void Dispose() { }

    private class MyLogger : ILogger, IDisposable
    {
        public IDisposable BeginScope<TState>(TState state) => this;
        public void Dispose() { }
        public bool IsEnabled(LogLevel logLevel) => true;
        
        public void Log<TState>(LogLevel logLevel, EventId eventId, TState state, Exception? exception, Func<TState, Exception?, string> formatter)
        {
            File.AppendAllText("log.txt", formatter(state, exception));
            Console.WriteLine(formatter(state, exception));
        }
    }
}
```  

---
#### **Фильтрация логов**  
Можно настраивать **категории** и **уровни** логгирования:  
```csharp
public static readonly ILoggerFactory MyLoggerFactory = LoggerFactory.Create(builder =>
{
    builder.AddFilter((category, level) => 
            category == DbLoggerCategory.Database.Command.Name && level == LogLevel.Information)
           .AddProvider(new MyLoggerProvider());
});
```  

---
### Outer links:
https://metanit.com/sharp/efcore/2.12.php