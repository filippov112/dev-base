#lang #lang-c_sharp 

---
Автоматически создается **промежуточная таблица**.
Начиная с EF Core 5.0, явное создание промежуточной сущности не требуется.  
- Каскадное удаление связей из промежуточной таблицы.
- Связывание равносильно в обе стороны (добавление курса студенту = добавление студента к курсу)
  ```csharp
  public class Course
  {
      public List<Student> Students { get; set; } = new();
  }
  public class Student
  {
      public List<Course> Courses { get; set; } = new();
  }
  ```  

**Промежуточная таблица в БД**:  
  ```sql
  CREATE TABLE "CourseStudent" (
      "CoursesId" INTEGER NOT NULL,
      "StudentsId" INTEGER NOT NULL,
      PRIMARY KEY ("CoursesId", "StudentsId")
  );
  ```

---
## Взаимодействие с промежуточной сущностью

##### **Установка названия:**
```csharp
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
  modelBuilder.Entity<Course>()
	  .HasMany(c => c.Students)
	  .WithMany(s => s.Courses)
	  .UsingEntity(j => j.ToTable("Enrollments")); // промежуточная таблица
}
```  

##### **Дополнительные поля:**  
1. **Инициализируем сущность с нужным полем**:  
	```csharp
	public class Enrollment
	{
		public int StudentId { get; set; }
		public Student? Student { get; set; }
		public int CourseId { get; set; }
		public Course? Course { get; set; }
		public int Mark { get; set; }  // Дополнительное поле (оценка)
	}
	```  
2. **Настройка связи**:  
	```csharp
	modelBuilder.Entity<Course>()
		.HasMany(c => c.Students)
		.WithMany(s => s.Courses)
		.UsingEntity<Enrollment>(
			j => j.HasOne(e => e.Student).WithMany(s => s.Enrollments),
			j => j.HasOne(e => e.Course).WithMany(c => c.Enrollments),
			j => 
			{
				j.Property(e => e.Mark).HasDefaultValue(3);
				j.HasKey(e => new { e.CourseId, e.StudentId });
				j.ToTable("Enrollments");
			});
	```  
3. **Результат**:  
	  ```sql
	  CREATE TABLE "Enrollments" (
		  "StudentId" INTEGER NOT NULL,
		  "CourseId" INTEGER NOT NULL,
		  "Mark" INTEGER DEFAULT 3,
		  PRIMARY KEY ("CourseId", "StudentId")
	  );
	  ```  

##### **Работа с промежуточной сущностью**  
- **Добавление**:  
  ```csharp
  student.Enrollments.Add(new Enrollment { Course = algorithms, Mark = 5 });
  ```  
- **Вывод**:  
  ```csharp
  foreach (var e in db.Enrollments.Include(e => e.Student))
      Console.WriteLine($"{e.Student.Name}: {e.Mark}");
  ```  

---
### Outer links:
https://metanit.com/sharp/efcore/3.6.php