#EntityFramework #Csharp 
# <font color="#00b0f0">EF Core:</font> Хранение истории изменений

Хранение истории изменений в **SQL Server** с помощью **системного управления версиями таблиц** (temporal tables - EF Core 6.0)
позволяет анализировать историю данных и осуществлять восстановление.

SQL Server создаёт параллельную таблицу для хранения истории изменений и добавляет два скрытых столбца: 
`PeriodStart` (начало временного интервала).
`PeriodEnd` (конец временного интервала).

---
#### Настройка
Настройка временной таблицы:
  ```csharp
 // `IsTemporal()` указывает, что таблица будет отслеживать историю изменений.
  protected override void OnModelCreating(ModelBuilder modelBuilder)
  {
      modelBuilder.Entity<User>()
          .ToTable("Users", t => t.IsTemporal());
  }
  ```

  ```csharp
  // Можно изменить названия столбцов и таблицы истории:
  modelBuilder.Entity<User>()
      .ToTable("Users", t => t.IsTemporal(h =>
      {
          h.HasPeriodStart("CreatedAt");
          h.HasPeriodEnd("DeletedAt");
          h.UseHistoryTable("PeopleDataHistory");
      }));
  ```

---
#### Получение данных из истории
  - `TemporalAsOf(date)` – состояние на определённую дату.
  - `TemporalAll()` – вся история.
  - `TemporalFromTo(start, end)` – изменения в интервале дат.
  - `TemporalBetween(start, end)` – аналогично `FromTo`, но включает конечную дату.
  - `TemporalContainedIn(start, end)` – состояния на моменты начальной и конечной дат.

  ```csharp
  var history = db.Users.TemporalAll()
      .Where(u => u.Id == 1)
      .OrderBy(e => EF.Property<DateTime>(e, "PeriodStart"))
      .Select(u => new 
      {
          User = u,
          Start = EF.Property<DateTime>(u, "PeriodStart"),
          End = EF.Property<DateTime>(u, "PeriodEnd")
      }).ToList();
  ```

---
#### Восстановление данных

  1. Удаление объекта:
     ```csharp
     db.Users.Remove(user);
     db.SaveChanges();
     ```
  2. Восстановление из истории:
     ```csharp
     var deletedUser = db.Users.TemporalAsOf(date).FirstOrDefault(u => u.Id == 1);
     db.Users.Add(deletedUser);
     db.SaveChanges();
     ```
  3. Для объектов с установленным `Id` может потребоваться отключение автогенерации:
     ```csharp
     db.Database.ExecuteSqlRaw("SET IDENTITY_INSERT [dbo].[Users] ON");
     // Добавление объекта
     db.Database.ExecuteSqlRaw("SET IDENTITY_INSERT [dbo].[Users] OFF");
     ```

---
### Outer links:
https://metanit.com/sharp/efcore/8.3.php