#EntityFramework #Csharp 
# <font color="#00b0f0">EF Core:</font> Собственные типы

**Собственные типы (Owned Entity Types)** – зависимые сущности, которые:
  - Не существуют отдельно от типа-владельца (owner).
  - Не имеют собственного ключа (первичного ключа).
  - Хранятся в таблице типа-владельца.
  
  Особенности:
  - Не поддерживают наследование.
  - Собственные типы могут содержать другие собственные типы.
  
**Цель**: Группировка связанных данных в рамках одной таблицы (например, профиль пользователя внутри сущности `User`).

---
### Способы определения

##### **Атрибут `[Owned]`**
Указывает, что класс является собственным типом.
  ```csharp
  public class User
  {
      public int Id { get; set; }
      public UserProfile? Profile { get; set; } // Навигационное свойство
  }

  [Owned]
  public class UserProfile
  {
      public string? Name { get; set; }
      public int Age { get; set; }
  }
  ```

  ```sql
  CREATE TABLE "Users" (
      "Id" INTEGER PRIMARY KEY AUTOINCREMENT,
      "Profile_Name" TEXT NULL,
      "Profile_Age" INTEGER NULL
  );
  ```

##### **Fluent API: метод `OwnsOne()`**
Настройка через метод `OwnsOne()` в `OnModelCreating`.
Позволяет кастомизировать имена столбцов и вложенные типы.
  ```csharp
  protected override void OnModelCreating(ModelBuilder modelBuilder)
  {
      modelBuilder.Entity<User>().OwnsOne(u => u.Profile);
  }
  ```

  ```csharp
  modelBuilder.Entity<User>().OwnsOne(typeof(UserProfile), "Profile"); // если поле приватное
  ```

  ```csharp
  // Вложенные собственные типы 
  // UserProfile { Claim Name, Claim Age }
  // Claim { Key, Value }
  
  modelBuilder.Entity<User>().OwnsOne(u => u.Profile, p => 
  {
      p.OwnsOne(c => c.Name);
      p.OwnsOne(c => c.Age);
  });
  
  // CREATE TABLE "Users" (
  //    "Id" INTEGER PRIMARY KEY AUTOINCREMENT,
  //    "Profile_Name_Key" TEXT NULL,
  //    "Profile_Name_Value" TEXT NULL,
  //    "Profile_Age_Key" TEXT NULL,
  //    "Profile_Age_Value" TEXT NULL
  // );

  ```

---
#### Использование

- **Добавление данных**:
  ```csharp
  var user = new User
  {
      Profile = new UserProfile { Name = "Tom", Age = 23 }
  };
  ```
- **Запрос данных**:
  ```csharp
  var users = db.Users.ToList();
  foreach (var user in users)
      Console.WriteLine($"Name: {user.Profile?.Name}");
  ```

---
### Outer links:
https://metanit.com/sharp/efcore/3.7.php