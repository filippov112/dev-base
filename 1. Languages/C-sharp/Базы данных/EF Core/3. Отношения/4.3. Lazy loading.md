#EntityFramework #Csharp 
# <font color="#00b0f0">EF Core:</font> Lazy loading

**Lazy Loading** – это автоматическая загрузка связанных данных при первом обращении к навигационному свойству.  
Позволяет избежать избыточной загрузки данных, подгружая связи только по требованию.  

**Условия для работы:**  
  - Подключение пакета `Microsoft.EntityFrameworkCore.Proxies`.  
  - Навигационные свойства должны быть `virtual` (виртуальными).  
  - Классы сущностей должны быть открыты для наследования (`public`).  

**Особенности:**  
  - Удобство: не нужно явно указывать загрузку связей (например, через `Include`).  
  - Экономия памяти: данные подгружаются только при необходимости.  
  - **N+1 проблема:** Множество запросов к БД при переборе коллекций.  
  - **Неактуальные данные:** Если данные в БД изменились, контекст продолжит использовать загруженные ранее значения.  

---
#### **Настройка**  
1. **Установка пакета:**  
   ```bash
   Install-Package Microsoft.EntityFrameworkCore.Proxies
   ```  
2. **Конфигурация контекста:**  
   ```csharp
   protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
   {
       optionsBuilder
           .UseLazyLoadingProxies()  // Включение Lazy Loading
           .UseSqlite("Data Source=helloapp.db");
   }
   ```  
3. **Пример моделей:**  
   ```csharp
   public class User
   {
       public virtual Company? Company { get; set; }  // Навигационное свойство (virtual)
   }
   ```  

---
#### **Пример работы**  
**Загрузка данных:**  
```csharp
var users = db.Users.ToList();  // Загружаются только пользователи (без компаний)
foreach (var user in users)
{
    Console.WriteLine($"{user.Name} - {user.Company?.Name}");  // Компании загружаются автоматически
}
```  
**SQL-запросы:**  
1. Первый запрос (получение пользователей):  
   ```sql
   SELECT "u"."Id", "u"."CompanyId", "u"."Name" FROM "Users" AS "u"
   ```  
2. Последующие запросы (при обращении к `user.Company`):  
   ```sql
   SELECT "c"."Id", "c"."Name" FROM "Companies" AS "c" WHERE "c"."Id" = @__p_0
   ```  
   - Запросы выполняются только для новых компаний (если данные уже в контексте – EF использует их).  

---
### Outer links:
https://metanit.com/sharp/efcore/3.9.php