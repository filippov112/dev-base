#db #sql

# Шпаргалка по работе с хранимыми процедурами в различных СУБД

Хранимые процедуры — это программные блоки, которые выполняются на стороне сервера базы данных. Они позволяют группировать логически связанные операции и могут принимать параметры, возвращать значения и обрабатывать транзакции.

---

## 1. **Создание хранимых процедур (CREATE PROCEDURE)**

### Общий синтаксис:
```sql
CREATE PROCEDURE procedure_name (parameters)
AS
BEGIN
    -- тело процедуры
END;
```

---

## 2. **Пример создания простой процедуры**

### T-SQL (SQL Server):
```sql
CREATE PROCEDURE dbo.GetEmployeeFullName
    @EmployeeID INT
AS
BEGIN
    SELECT FirstName, LastName
    FROM Employees
    WHERE EmployeeID = @EmployeeID;
END;
```

### PostgreSQL:
```sql
CREATE OR REPLACE PROCEDURE GetEmployeeFullName(IN EmployeeID INT)
LANGUAGE plpgsql
AS $$
BEGIN
    PERFORM FirstName || ' ' || LastName
    FROM Employees
    WHERE EmployeeID = EmployeeID;
END;
$$;
```

### MySQL:
```sql
CREATE PROCEDURE GetEmployeeFullName(IN EmployeeID INT)
BEGIN
    SELECT FirstName, LastName
    FROM Employees
    WHERE EmployeeID = EmployeeID;
END;
```

**Пояснение**: Эти процедуры извлекают имя и фамилию сотрудника по заданному `EmployeeID`.

---

## 3. **Вызов хранимой процедуры**

### Пример вызова процедуры:

#### T-SQL (SQL Server):
```sql
EXEC dbo.GetEmployeeFullName @EmployeeID = 1;
```

#### PostgreSQL:
```sql
CALL GetEmployeeFullName(1);
```

#### MySQL:
```sql
CALL GetEmployeeFullName(1);
```

---

## 4. **Процедуры с выходными параметрами**

Выходные параметры позволяют возвращать значения из процедуры.

### Пример процедуры с выходным параметром:

#### T-SQL (SQL Server):
```sql
CREATE PROCEDURE dbo.GetEmployeeCount
    @DepartmentID INT,
    @EmployeeCount INT OUTPUT
AS
BEGIN
    SELECT @EmployeeCount = COUNT(*)
    FROM Employees
    WHERE DepartmentID = @DepartmentID;
END;
```

#### PostgreSQL:
```sql
CREATE OR REPLACE PROCEDURE GetEmployeeCount(IN DepartmentID INT, OUT EmployeeCount INT)
LANGUAGE plpgsql
AS $$
BEGIN
    SELECT COUNT(*)
    INTO EmployeeCount
    FROM Employees
    WHERE DepartmentID = DepartmentID;
END;
$$;
```

#### MySQL:
```sql
CREATE PROCEDURE GetEmployeeCount(IN DepartmentID INT, OUT EmployeeCount INT)
BEGIN
    SELECT COUNT(*)
    INTO EmployeeCount
    FROM Employees
    WHERE DepartmentID = DepartmentID;
END;
```

**Пояснение**: Эти процедуры подсчитывают количество сотрудников в заданном отделе и возвращают это значение.

---

## 5. **Изменение и удаление процедур**

### Изменение процедуры (ALTER PROCEDURE):
В большинстве СУБД для изменения процедуры необходимо сначала удалить ее, а затем создать заново.

### Пример удаления процедуры:
```sql
DROP PROCEDURE dbo.GetEmployeeFullName;  -- T-SQL
DROP PROCEDURE GetEmployeeFullName;       -- PostgreSQL
DROP PROCEDURE GetEmployeeFullName;       -- MySQL
```

---

## 6. **Транзакции в процедурах**

Хранимые процедуры могут использовать транзакции для управления целостностью данных.

### Пример процедуры с транзакцией:

#### T-SQL (SQL Server):
```sql
CREATE PROCEDURE dbo.UpdateEmployeeSalary
    @EmployeeID INT,
    @NewSalary DECIMAL(10, 2)
AS
BEGIN
    BEGIN TRANSACTION;
    BEGIN TRY
        UPDATE Employees
        SET Salary = @NewSalary
        WHERE EmployeeID = @EmployeeID;

        COMMIT TRANSACTION;
    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION;
        -- обработка ошибок
    END CATCH
END;
```

#### PostgreSQL:
```sql
CREATE OR REPLACE PROCEDURE UpdateEmployeeSalary(IN EmployeeID INT, IN NewSalary DECIMAL)
LANGUAGE plpgsql
AS $$
BEGIN
    BEGIN;
        UPDATE Employees
        SET Salary = NewSalary
        WHERE EmployeeID = EmployeeID;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        -- обработка ошибок
END;
$$;
```

#### MySQL:
```sql
CREATE PROCEDURE UpdateEmployeeSalary(IN EmployeeID INT, IN NewSalary DECIMAL(10, 2))
BEGIN
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        -- обработка ошибок
    END;

    START TRANSACTION;
    UPDATE Employees
    SET Salary = NewSalary
    WHERE EmployeeID = EmployeeID;

    COMMIT;
END;
```

**Пояснение**: Эти процедуры обновляют зарплату сотрудника в рамках транзакции, обеспечивая целостность данных.

---

## 7. **Циклы и условия в процедурах**

Процедуры могут содержать циклы и условные операторы для выполнения сложных логических операций.

### Пример с условием и циклом:

#### T-SQL (SQL Server):
```sql
CREATE PROCEDURE dbo.ProcessEmployeeSalaries
AS
BEGIN
    DECLARE @EmployeeID INT;
    DECLARE @Salary DECIMAL(10, 2);
    DECLARE cur CURSOR FOR SELECT EmployeeID, Salary FROM Employees;

    OPEN cur;
    FETCH NEXT FROM cur INTO @EmployeeID, @Salary;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        IF @Salary < 30000
            UPDATE Employees SET Salary = Salary * 1.1 WHERE EmployeeID = @EmployeeID;

        FETCH NEXT FROM cur INTO @EmployeeID, @Salary;
    END

    CLOSE cur;
    DEALLOCATE cur;
END;
```

#### PostgreSQL:
```sql
CREATE OR REPLACE PROCEDURE ProcessEmployeeSalaries()
LANGUAGE plpgsql
AS $$
DECLARE
    EmployeeRec RECORD;
BEGIN
    FOR EmployeeRec IN SELECT EmployeeID, Salary FROM Employees LOOP
        IF EmployeeRec.Salary < 30000 THEN
            UPDATE Employees SET Salary = Salary * 1.1 WHERE EmployeeID = EmployeeRec.EmployeeID;
        END IF;
    END LOOP;
END;
$$;
```

#### MySQL:
```sql
CREATE PROCEDURE ProcessEmployeeSalaries()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE EmployeeID INT;
    DECLARE Salary DECIMAL(10, 2);

    DECLARE cur CURSOR FOR SELECT EmployeeID, Salary FROM Employees;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

    OPEN cur;

    read_loop: LOOP
        FETCH cur INTO EmployeeID, Salary;
        IF done THEN
            LEAVE read_loop;
        END IF;

        IF Salary < 30000 THEN
            UPDATE Employees SET Salary = Salary * 1.1 WHERE EmployeeID = EmployeeID;
        END IF;
    END LOOP;

    CLOSE cur;
END;
```

**Пояснение**: Эти процедуры обрабатывают зарплаты сотрудников, увеличивая их на 10% для тех, кто зарабатывает меньше 30,000.

---

## 8. **Возврат значений из процедур**

В большинстве СУБД процедуры не возвращают значения напрямую, но можно использовать выходные параметры или временные таблицы для этого.

### Пример возврата значения через выходные параметры:
```sql
-- Используйте примеры, приведенные выше с выходными параметрами.
```

---

## 9. **Логирование и отладка**

Включение логирования и отладка кода в процедурах может помочь в обнаружении проблем.

### Пример логирования:
```sql
-- В T-SQL можно использовать INSERT для логирования информации о выполнении.
INSERT INTO LogTable (Message) VALUES ('Procedure executed successfully.');
```

---

## 10. **Заключение**

Хранимые процедуры являются мощным инструментом для управления данными и выполнения бизнес-логики в базе данных. Они позволяют абстрагировать сложные операции и улучшать производительность системы. Использование выходных параметров, транзакций, циклов и условий делает их очень гибкими. Правильное проектирование и тестирование процедур помогут создать надежную и производительную систему.