
# Cassandra

**Apache Cassandra** — это распределённая NoSQL-СУБД, для работы с большими объёмами данных и высокой отказоустойчивости. 

- Аналитические платформы, IoT, телекоммуникации и финтех)
- Требует тщательного планирования структуры данных и мониторинга кластера.
- Децентрализованное распределённое хранилище. 

#### Механизмы работы:

> [!info] **Модель _peer-to-peer_**
> Все узлы равны. Любой узел может принять запрос на чтение или запись. 

> [!info] **Репликация данных**
> Данные копируются на несколько узлов. Количество копий (реплик) и способ их распределения задаются стратегиями репликации:
> - _SimpleStrategy_ — простая стратегия для одного дата-центра: реплики размещаются по кругу среди узлов.
> - _NetworkTopologyStrategy_ — более сложная стратегия, для работы в нескольких дата-центрах: реплики распределяются с учётом их расположения в сети, чтобы повысить отказоустойчивость.

> [!info] **Туннель времени (_Hinted Handoff_) и механизмы согласования**
> Механизмы поддержания актуальности данных:
> - _Hinted Handoff_ (туннель времени) — если один из узлов недоступен при записи, другой узел временно сохраняет изменения и передаёт их, когда узел восстановится.
> - _Read Repair_ — при чтении данных Cassandra сравнивает копии реплик и исправляет устаревшие версии.
> - _Anti-Entropy_ — фоновый процесс, который периодически проверяет и синхронизирует данные между узлами.

> [!info] **Уровни согласованности (_Consistency Level_)**
> Позволяют выбирать между высокой доступностью и строгой консистентностью
> - `ANY` — для подтверждения операции чтения/записи достаточно записи хотя бы на один узел, даже если он не хранит реплику (данные сохраняются в _Hinted Handoff_).
> - `ONE` — хотя бы одна реплика.
> - `QUORUM` — большинство реплик.
> - `ALL` — все реплики.

### Хранение данных

Данные в Cassandra хранятся в **таблицах** (column families), но их структура ближе к key-value хранилищам:
- **Партицирование** — процесс распределения строк по узлам кластера на основе партиционного ключа. Каждый ключ хешируется (Murmur3, Random, ByteOrdered), а полученное значение определяет, на каком узле будут храниться данные.
<br>
- **Партиции** — группы строк с одинаковым партиционным ключом, распределённые по узлам. Они обеспечивают быстрый доступ к данным внутри одного узла.
<br>
- **Партиционные ключи** — определяют, как данные распределяются в кластере, и влияют на балансировку нагрузки.
<br>
- **SSTable (Sorted String Table)** — неизменяемые файлы хранения данных, создаваемые при сбросе данных из памяти (memtable) на диск. Они состоят из индексов, данных и метаданных.
<br>
- **Компакция SSTable** — процесс объединения нескольких SSTable в один файл для уменьшения фрагментации и улучшения производительности. Она проводится автоматически и включает удаление устаревших данных, слияние записей и оптимизацию структуры хранения.

### Проектирование схемы хранения

Cassandra не поддерживает реляционные связи, поэтому схема данных разрабатывается с учётом паттернов доступа. 
Основные принципы:
- **Моделирование на основе запросов** — схема проектируется исходя из типов запросов, а не нормализации данных.
- **Использование партиционных ключей** — помогает равномерно распределять данные по узлам.
- **Денормализация и дублирование** — применяются для оптимизации чтения.

---
### Сильные и слабые стороны
Сильные:
- Высокая отказоустойчивость и отсутствие единой точки отказа.
- Линейное горизонтальное масштабирование без простоев.
- Гибкая модель данных, подходящая для работы с огромными массивами информации.
- Регулируемые уровни консистентности для разных сценариев работы.

Слабые:
- Не поддерживает сложные SQL-запросы и джойны.
- Требует тщательного проектирования схемы данных.
- Высокая сложность управления кластером.
- Возможны задержки при записи из-за механизмов репликации и согласования.

---
### Хорошие и плохие практики
Хорошие:
- Использовать **правильные партиционные ключи** для равномерного распределения нагрузки.
- Оптимизировать чтение и запись, минимизируя сканирование партиций.
- Настраивать **RF (replication factor) и CL (consistency level)** в зависимости от требований к доступности и согласованности.
- Регулярно проводить **компакцию SSTable** для оптимизации хранения и скорости запросов.

Плохие:
- Использование **больших партиций**, так как это замедляет операции чтения и записи.
- Отсутствие мониторинга и настройки кластера, что может привести к дисбалансу нагрузки.
- Проектирование схемы **без учёта паттернов доступа**, что приводит к неэффективным запросам и избыточному потреблению ресурсов.


