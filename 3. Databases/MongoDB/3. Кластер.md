№400   
# <font color="#00b0f0">MongoDB:</font> Кластер

**<font color="#ffff00">Кластер</font>** — это группа серверов.

---
### Механизмы кластера

#### <font color="#ffff00">Реплицирование</font> — дублирование БД на несколько запасных серверов (Secondary).
**Реплика** — сервер с копией БД.
**Репликасет** (replica set) — группа реплик. *Primary* - 1 - обрабатывает все операции записи и чтения. *Secondary* - несколько - синхронизируют данные с primary и могут использоваться для чтения (если это разрешено настройками).
- в случае отказов, реплики меняются ролями автоматически
- можно распределять нагрузку на чтение.

#### <font color="#ffff00">Шардирование</font> - распределение данных между несколькими серверами.
**Шард** — часть данных на сервере/репликасете.
**Конфигурационные серверы** (Config Servers) — ранят метаданные о распределении данных по шардам кластера.
**Маршрутизатор** (Mongos) — процесс, перенаправляющий запросы к правильным шардам.


---

### Пример настройки кластера

#### a) <font color="#ffff00">Репликасет</font>
1. Запустите три экземпляра MongoDB:
   ```bash
   mongod --replSet myReplicaSet --port 27017 --dbpath /data/db1
   mongod --replSet myReplicaSet --port 27018 --dbpath /data/db2
   mongod --replSet myReplicaSet --port 27019 --dbpath /data/db3
   ```
2. Инициализируйте репликасет:
   ```bash
   mongosh --port 27017
   rs.initiate()
   rs.add("localhost:27018")
   rs.add("localhost:27019")
   ```

#### b) <font color="#ffff00">Шардированный кластер</font>
1. Запустите конфигурационные серверы:
   ```bash
   mongod --configsvr --replSet configReplSet --port 27019 --dbpath /data/configdb
   ```
2. Запустите шарды:
   ```bash
   mongod --shardsvr --replSet shardReplSet --port 27018 --dbpath /data/sharddb
   ```
3. Запустите маршрутизатор:
   ```bash
   mongos --configdb configReplSet/localhost:27019 --port 27017
   ```
4. Добавьте шарды в кластер:
   ```bash
   mongosh --port 27017
   sh.addShard("shardReplSet/localhost:27018")
   ```

### Outer links:
