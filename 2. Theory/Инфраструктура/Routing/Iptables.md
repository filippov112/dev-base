
>[!warning] Внимание! Устаревший инструмент. Заменен  на [Nftables](2.%20Theory/Инфраструктура/Routing/Nftables.md)

>[!note] Утилита работает только из под root или sudo.

**Iptables** - это утилита командной строки, используемая для **управления межсетевым экраном Netfilter** в Linux. 
Она позволяет фильтровать сетевой трафик, проходящий через систему, на основе различных критериев, таких как **IP-адреса, порты, протоколы и т.д.**
- Утилита базируется на *таблицах*, состоящих из *цепочек*, состоящих из *правил*.
- По умолчанию действует *открытая* политика, когда все маршруты для всех пакетов, не попадающих в правила - открыты. После настройки нужных маршрутов политика меняется на закрытую.
- Если не сохранять настройку правил в файл и не настраивать автозагрузку правил при перезапуске системы, то после ребута правила <font color="#ff0000">сбрасываются</font>!
- Цепочки правил выполняются последовательно до совпадения, т.е. правила черного списка желательно ставить в начало.

>[!info] Рисунок 1 - Схема прохождения пакетов в системе
>![](heap/_files/Сети/Pasted%20image%2020240603175819.png)

>[!info] Рисунок 2 - Маршрутизация пакетов по *всем цепочкам* *всех таблиц*
>![](heap/_files/Сети/Pasted%20image%2020240603202556.png)

#### Таблицы
1. **Filter** - это основная таблица, используемая для фильтрации пакетов.
2. **NAT** - эта таблица используется для настройки NAT (Network Address Translation).
3. **Mangle** - эта таблица используется для специальной обработки пакетов.
4. **Raw** - эта таблица используется для обхода системы отслеживания состояний.

#### Цепочки
Определяют направления пакетов к которым будет применяться фильтрация.
1. **INPUT** - \*целевые входящие пакеты
2. **OUTPUT** - \*целевые исходящие пакеты
3. **FORWARD** - транзитные входящие пакеты
4. **PREROUTING** - все входящие пакеты (input + forward)
5. **POSTROUTING** - все исходящие пакеты (output + forward)
\* - под целевыми понимаются пакеты с адресатом/адресантом в лице данной машины.

#### Действия
1. ACCEPT - разрешение
2. DROP - игнорирование
3. REJECT - игнорирование с ответом
4. LOG - просто делает запись в логе, если пакет соответствует критериям правила;
5. MASQUERADE - используется на маршрутизаторах (таблица NAT) для назначению пакету публичного IP адреса перед отправкой.
	- `iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE` - применение маскарада для исходящего трафика отдельного интерфейса.
6. DNAT - переназначение маршрута по признаку цели
7. SNAT - переназначение маршрута по признаку источника
8. LOG - логирование

#### Параметры
- `!` - логическое НЕ;
- Управление правилами

|**коротко**|**синтаксис правила**|**применение**|
|---|---|---|
|-A|--append {цепочка правила}|добавить правило к цепочке (в самое начало)|
|-D|--delete {цепочка правила}|удалить правило из цепочки|
|-D|--delete {номер правила в цепочке}|удалить правило из цепочки по номеру (1 - x)|
|-I|--insert {номер правила вцепочке}|вставить правило в цепочку по номеру (1 - x)|
|-R|--replace {номер правила вцепочке}|заменить правило в цепочке по номеру (1 - x)|
|-X|--delete-chain {цепочка}|удалить цепочку (только для пользовательских)|
|-E|--rename-chain {старое имя цепочки} {новое имя цепочки}|переименовать цепочку|
|-N|--new {имя цепочки}|создание новой пользовательской цепочки|
|-C|--check {правило цепочки}|проверит наличие правила в цепочке|
|-F|--flush {цепочка}|удаляет все правила в цепочке, если цепочка не указана – удалятся все правила|
|-Z|--zero {цепочка} {номер правила вцепочке}|обнуляет все счётчики пакетов и байтов в цепочке или всех цепочках|
|-P|--policy {цепочка} {номер правила вцепочке}|изменяет политику по умолчанию, она должна основываться на встроенном target’e {ACCEPT, DROP, QUEUE}|

- Написание правил

|**коротко**|**синтаксис опции**|**применение**|
|---|---|---|
|-p|(!) --proto {протокол}|протокол {tcp, udp, udplite, icmp, esp, ah, sctp} или номер протокола {16,7}, all - все протоколы|
|-4|--ipv4|указывает версию протокола ipv4|
|-6|--ipv6|указывает версию протокола ipv6|
|-s|(!) --source {адрес/маска}|указывает ip адрес источника|
|-d|(!) --destination {адрес/маска}|указывает ip адрес назначения|
|-m|--match|включает дополнительные модули, явно задающимися данным ключем. например <code>m limit --limit 3/min</code> - установит лимит на количество пакетов в минуту|
|-f|(!) --fragment|включает обработку фрагментированных пакетов, в которых нет параметров изначального полного пакета, содержащихся в первом фрагменте пакета|
|-i|(!) --in-interface {имя интерфейса}|обрабатывает только входящие пакеты, прилетающие на сетевой интерфейс {имя интерфейса}|
|-o|(!) --out-interface {имя интерфейса}|обрабатывает только исходящие пакеты, прилетающие на сетевой интерфейс {имя интерфейса}|
||--set-counters {пакеты} {байты}|включает счётчик для ключей--insert, --append, --replace|

- Применяемые действия

|**коротко**|**синтаксис опции**|**применение**|
|---|---|---|
|-j|--jump {действие}|применяет одно из действий accept, drop, reject и другие|
|-g|--goto {цепочка}|переходит к другой цепочке правил|

- Просмотр правил

|**коротко**|**синтаксис команды**|**применение**|
|---|---|---|
|-l|--list {цепочка} {номер правила}|показывает правила в цепочке или всех цепочках. по умолчанию покажет таблицу filter|
|-s|--list-rules{цепочка} {номер правила}|показывает текст правила в цепочке или всех цепочках|
|-n|--numeric|покажет параметры правила в числовом виде. например не порт будет не http, а 80|
|-v|--verbose|выводит более подробную информацию|
|-v|--version|покажет версию iptables|
|-x|--exact|покажет точные значения числовых параметров|
||--line-numbers|покажет номера правил|

## Примеры команд
##### Filter
- *Просмотр* всех правил  `iptables -L -nv` (filter), `iptables -t filter -L -nv` (для конкретной таблицы)
- Список прослушиваемых приложениями портов `ss -ntulp` (u - UDP сокеты)
- Список интерфейсов `ip a`
- Разрешение для *SSH* `iptables -A INPUT -p tcp --dport=22 -j ACCEPT`
	- Для отдельного *интерфейса* `iptables -A INPUT -i enp0s3 -p TCP --dport 22 -j ACCEPT`
- Разрешение для трафика внутри *localhost* `iptables -A INPUT -i lo -j ACCEPT`
- Разрешение для *ping-пакетов* `iptables -A INPUT -p icmp -j ACCEPT`
- Разрешение для *веб-сервера* `iptables -A INPUT -p tcp --dport=80 -j ACCEPT` (и 443)
- Разрешение ответных пакетов `iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT`
- Закрытие *политики* для цепочки `iptables -P INPUT DROP`
- *Блокировка* адреса `iptables -I INPUT -s 1.2.3.4 -j DROP`
- Удаление правила `iptables -D OUTPUT -o eth0 -p TCP --sport 22 -j ACCEPT` 
	- или по номеру в цепочке `iptables -D INPUT 3`
- Разрешение транзитного входящего трафика между интерфейсами `iptables -A FORWARD -i enp0s8 -o enp0s3 -j ACCEPT`
##### NAT
- Применение маскарада для исходящего трафика отдельного интерфейса `iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE` 
- Перенаправление трафика с одного порта на другой `iptables -t nat -A PREROUTING -p tcp --dport 9022 -j DNAT --to 192.168.56.6:22` (в данном случае проброска SSH)
##### Прочее
- *Сохранение* текущего состояния таблиц в файл `iptables-save > ./iptables.rules`
- *Загрузка* таблиц из файла `iptables-restore < ./iptables.rules`
- Пакеты для *автозагрузки* правил `iptables-persistent netfilter-persistent`. 
	- После установки будут загружаться правила из файла `/etc/iptables/rules.v4` (v6 для ipv6)
	- Сохранение конфигурации `netfilter-persistent save`
	- Запуск службы `netfilter-persistent start`
	- Перезагрузка службы `service netfilter-persistent reload`

## Ссылки
https://linux.die.net/man/8/iptables - документация